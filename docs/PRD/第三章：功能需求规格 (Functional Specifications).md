## ç¬¬ä¸‰ç« ï¼šåŠŸèƒ½éœ€æ±‚è§„æ ¼ (Functional Specifications)**

### **3.1 åˆ†é˜¶æ®µå‘å¸ƒç­–ç•¥**

æ ¹æ®è¯„å®¡å»ºè®®ï¼ŒV1.0å°†åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µå‘å¸ƒï¼Œé€æ­¥éªŒè¯æ ¸å¿ƒå‡è®¾ï¼š

| é˜¶æ®µ           | æ—¶é—´      | æ ¸å¿ƒåŠŸèƒ½                | éªŒè¯ç›®æ ‡                      | ç”¨æˆ·è§„æ¨¡   |
| -------------- | --------- | ----------------------- | ----------------------------- | ---------- |
| **Alphaå†…æµ‹**  | Week 7-8  | US1, US2, US6ï¼ˆç®€åŒ–ç‰ˆï¼‰ | éªŒè¯"è¯­éŸ³è¾“å…¥+å¤ä¹ "çš„æ ¸å¿ƒé—­ç¯ | 50-100äºº   |
| **Betaå…¬æµ‹**   | Week 9-14 | + US3, US4, US5, US7    | éªŒè¯å®Œæ•´ä½“éªŒä¸AIè´¨é‡          | 500-1000äºº |
| **V1.0æ­£å¼ç‰ˆ** | Week 15+  | æ€§èƒ½ä¼˜åŒ–ã€Bugä¿®å¤       | è¾¾æˆKPIç›®æ ‡                   | å…¨é‡å¼€æ”¾   |

---

### **3.2 US1: æ–°ç”¨æˆ·å¼•å¯¼ - æ’­ä¸‹ç¬¬ä¸€é¢—æ€æƒ³çš„ç§å­**

#### **3.2.1 åŠŸèƒ½ç›®æ ‡**

**Alphaé˜¶æ®µç›®æ ‡ï¼š**

- è®©ç”¨æˆ·åœ¨**60ç§’å†…**å®Œæˆä»æ‰“å¼€å°ç¨‹åºåˆ°åˆ›å»ºé¦–ä¸ªèŠ‚ç‚¹çš„å…¨æµç¨‹
- é¦–æ¬¡èŠ‚ç‚¹åˆ›å»ºç‡ â‰¥ 50%
- è·å–å¿…è¦çš„ç³»ç»Ÿæƒé™ï¼ˆå¾®ä¿¡æˆæƒã€éº¦å…‹é£ï¼‰

**Betaé˜¶æ®µæ–°å¢ï¼š**

- é€šè¿‡"ç¤ºä¾‹åŒ…"æå‰å±•ç¤ºäº§å“è¿æ¥ä»·å€¼
- è·å–"è®¢é˜…æ¶ˆæ¯"æƒé™

---

#### **3.2.2 æµç¨‹å›¾ (Flowchart)**

**Alphaç‰ˆæœ¬æµç¨‹ï¼š**

```mermaid
graph TD
    A[ç”¨æˆ·é¦–æ¬¡æ‰“å¼€å°ç¨‹åº] --> B{æ˜¾ç¤ºæ¬¢è¿é¡µ<br/>3ç§’åŠ¨ç”»};
    B --> C["ç‚¹å‡»'å¼€å¯ç»‡å¿µä¹‹æ—…'"];
    C --> D{è¯·æ±‚å¾®ä¿¡æˆæƒ};
    D -- æˆæƒæˆåŠŸ --> E{è¯·æ±‚éº¦å…‹é£æƒé™};
    D -- æ‹’ç» --> D1["æ˜¾ç¤ºæˆæƒå¿…è¦æ€§è¯´æ˜<br/>æä¾›'é‡è¯•'æŒ‰é’®"];
    D1 --> D;
    E -- æˆæƒæˆåŠŸ --> F["å¼•å¯¼å¼è¯­éŸ³è¾“å…¥é¡µ<br/>'è¯´å‡ºæ­¤åˆ»çš„æƒ³æ³•...'"];
    E -- æ‹’ç» --> E1[æ˜¾ç¤ºéº¦å…‹é£æƒé™é‡è¦æ€§<br/>æ— éº¦å…‹é£åˆ™æ— æ³•ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½];
    E1 --> E;
    F --> G[ç”¨æˆ·é•¿æŒ‰éº¦å…‹é£è¯´è¯];
    G --> H["æ˜¾ç¤º'æ­£åœ¨ç¼–ç»‡...'åŠ¨ç”» 3-5ç§’"];
    H --> I{AIå¤„ç†æˆåŠŸ?};
    I -- Yes --> J[å±•ç¤ºç”Ÿæˆçš„æ™ºæ…§èŠ‚ç‚¹];
    I -- No --> K["ä¿å­˜åŸå§‹è¾“å…¥ æç¤º'AIæœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œå·²ä¿å­˜'"];
    J --> L[è¿›å…¥ä¸»ç•Œé¢];
    K --> L;
```

**Betaç‰ˆæœ¬æ–°å¢æµç¨‹ï¼š**

```mermaid
graph TD
    J[å±•ç¤ºé¦–ä¸ªæ™ºæ…§èŠ‚ç‚¹] --> M{"å¼¹å‡º'ç¤ºä¾‹åŒ…'å¼•å¯¼"};
    M --> N["æƒ³çœ‹çœ‹æ€æƒ³å¦‚ä½•è¿æ¥å—ï¼Ÿ<br/>ä¸ºä½ å‡†å¤‡äº†ç¤ºä¾‹åŒ…"];
    N -- åŒæ„å¯¼å…¥ --> O[å¯¼å…¥3ä¸ªé¢„è®¾èŠ‚ç‚¹<br/>æ’­æ”¾è¿æ¥åŠ¨ç”»];
    N -- æ‹’ç»/å…³é—­ --> P;
    O --> P{"è¯·æ±‚'è®¢é˜…æ¶ˆæ¯'æƒé™"};
    P -- åŒæ„ --> Q[è¿›å…¥ä¸»ç•Œé¢];
    P -- æ‹’ç»/å…³é—­ --> Q;
```

---

#### **3.2.3 ç•Œé¢ä¸äº¤äº’ (UI & UX)**

**æ¬¢è¿é¡µ (Welcome Screen):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚         [åŠ¨æ€æ˜Ÿç©ºèƒŒæ™¯]           â”‚
â”‚                                 â”‚
â”‚        âœ¨ Weave (ç»‡å¿µ)          â”‚
â”‚                                 â”‚
â”‚      ç¼–ç»‡æ€æƒ³ï¼Œæ”¶è·æ™ºæ…§          â”‚
â”‚                                 â”‚
â”‚    [å¼€å¯æˆ‘çš„ç»‡å¿µä¹‹æ—…]  â† CTAæŒ‰é’®â”‚
â”‚         (å‘å…‰æ•ˆæœ)              â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- èƒŒæ™¯ï¼šæ·±é‚ƒæ˜Ÿç©ºè“ (#0A0F2C) + ç¼“æ…¢ç§»åŠ¨çš„æ˜Ÿäº‘ç²’å­
- æ ‡é¢˜ï¼šç™½è‰² (#F0F0F0)ï¼Œå­—å·36pxï¼ŒPingFang SC Medium
- å‰¯æ ‡é¢˜ï¼šæœˆå…‰ç™½70%é€æ˜åº¦ï¼Œå­—å·16px
- CTAæŒ‰é’®ï¼šçµæ„Ÿç´« (#A78BFA)ï¼Œåœ†è§’16pxï¼Œé«˜åº¦48px
- åŠ¨ç”»ï¼šæ˜Ÿäº‘æ±‡èšæ•ˆæœï¼Œ3ç§’å¾ªç¯
```

**å¼•å¯¼å¼è¯­éŸ³è¾“å…¥é¡µ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    [< è¿”å›]              [è·³è¿‡] â”‚  â† ä»…Alphaç‰ˆæ˜¾ç¤º
â”‚                                 â”‚
â”‚                                 â”‚
â”‚   è¯´å‡ºæ­¤åˆ»çš„æƒ³æ³•               â”‚
â”‚   æ’­ä¸‹ç¬¬ä¸€é¢—æ€æƒ³çš„ç§å­...       â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚         ğŸ¤                      â”‚  â† å¤§éº¦å…‹é£å›¾æ ‡
â”‚      (é•¿æŒ‰è¯´è¯)                 â”‚     åŠ¨æ€æ³¢çº¹æ•ˆæœ
â”‚                                 â”‚
â”‚                                 â”‚
â”‚  [å®æ—¶è½¬å†™æ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸ]          â”‚  â† Betaç‰ˆæ–°å¢
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- é•¿æŒ‰éº¦å…‹é£ï¼šå¼€å§‹å½•éŸ³ï¼Œå›¾æ ‡å˜ä¸ºçº¢è‰²è„‰å†²
- æ¾å¼€éº¦å…‹é£ï¼šç»“æŸå½•éŸ³ï¼Œæ˜¾ç¤º"æ­£åœ¨ç¼–ç»‡..."
- å½•éŸ³æ—¶é•¿é™åˆ¶ï¼šæœ€çŸ­2ç§’ï¼Œæœ€é•¿60ç§’
- è¶…è¿‡50ç§’æ—¶ï¼šåº•éƒ¨å‡ºç°å€’è®¡æ—¶æç¤º
```

**AIå¤„ç†åŠ¨ç”»:**

```
è§†è§‰æ•ˆæœï¼š
1. æ–‡å­—ç¢ç‰‡ä»å››å‘¨é£å…¥
2. åœ¨ä¸­å¿ƒæ±‡èšæˆä¸€ä¸ªå…‰ç‚¹
3. å…‰ç‚¹æ‰©æ•£å½¢æˆèŠ‚ç‚¹å¡ç‰‡
4. å¡ç‰‡é€æ¸æ¸…æ™°ï¼ˆå†…å®¹æ¸æ˜¾ï¼‰

åŠ¨ç”»æ—¶é•¿ï¼š3-5ç§’
æ–‡æ¡ˆï¼š
- "æ­£åœ¨ç¼–ç»‡æ€æƒ³..." (0-2ç§’)
- "æ­£åœ¨å‘ç°è¿æ¥..." (2-4ç§’ï¼ŒBetaç‰ˆ)
- "æ™ºæ…§èŠ‚ç‚¹å·²ç”Ÿæˆ" (4-5ç§’)
```

**é¦–ä¸ªæ™ºæ…§èŠ‚ç‚¹å±•ç¤º:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ¨ ä½ çš„ç¬¬ä¸€ä¸ªæ™ºæ…§èŠ‚ç‚¹            â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“Œ [AIç”Ÿæˆçš„æ ‡é¢˜]          â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ [AIç²¾ç‚¼åçš„æ ¸å¿ƒå†…å®¹]       â”‚ â”‚
â”‚  â”‚ [æœ€å¤šæ˜¾ç¤º3è¡Œï¼Œå¯å±•å¼€]      â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ #æ ‡ç­¾1 #æ ‡ç­¾2             â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ [æŸ¥çœ‹å®Œæ•´å†…å®¹] â†’          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  [ç»§ç»­åˆ›å»º]   [è¿›å…¥ä¸»ç•Œé¢]      â”‚  â† Alphaç‰ˆ
â”‚  [å¯¼å…¥ç¤ºä¾‹åŒ…]   [è¿›å…¥ä¸»ç•Œé¢]    â”‚  â† Betaç‰ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**"ç¤ºä¾‹åŒ…"å¼¹çª— (Betaç‰ˆ):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒ³çœ‹çœ‹æ€æƒ³æ˜¯å¦‚ä½•è¿æ¥çš„å—ï¼Ÿ      â”‚
â”‚                                 â”‚
â”‚  æˆ‘ä»¬ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ª              â”‚
â”‚  ã€Šé«˜æ•ˆå­¦ä¹ æ–¹æ³•ã€‹ç¤ºä¾‹åŒ…          â”‚
â”‚                                 â”‚
â”‚  åŒ…å«3ä¸ªç²¾é€‰çŸ¥è¯†èŠ‚ç‚¹ï¼š           â”‚
â”‚  â€¢ è´¹æ›¼å­¦ä¹ æ³•                   â”‚
â”‚  â€¢ é—´éš”é‡å¤åŸç†                 â”‚
â”‚  â€¢ ä¸»åŠ¨å¬å›æŠ€å·§                 â”‚
â”‚                                 â”‚
â”‚  å®ƒä»¬ä¹‹é—´å·²ç»å»ºç«‹äº†æ™ºæ…§è¿æ¥      â”‚
â”‚                                 â”‚
â”‚  [å¥½çš„ï¼Œç«‹å³å¯¼å…¥]               â”‚  â† ä¸»æŒ‰é’®
â”‚  [ä¸äº†ï¼Œè°¢è°¢]                   â”‚  â† æ¬¡çº§æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- æ¨¡æ€å¼¹çª—ï¼Œå¸¦20%é€æ˜åº¦é»‘è‰²é®ç½©
- å¼¹çª—åœ†è§’24pxï¼Œç™½è‰²èƒŒæ™¯
- ä¸»æŒ‰é’®ï¼šçµæ„Ÿç´«å¡«å……
- æ¬¡çº§æŒ‰é’®ï¼šé€æ˜èƒŒæ™¯ï¼Œç°è‰²æ–‡å­—
```

---

#### **3.2.4 æŠ€æœ¯è¦æ±‚**

**Alphaé˜¶æ®µï¼š**

- å‰ç«¯éœ€å¤„ç†å¾®ä¿¡`wx.getUserProfile`å’Œ`wx.authorize`çš„å®Œæ•´é€»è¾‘
- å®ç°æµç•…çš„CSS/LottieåŠ¨ç”»ï¼ˆæ¬¢è¿é¡µã€AIå¤„ç†åŠ¨ç”»ï¼‰
- å½•éŸ³ç®¡ç†å™¨çš„æ­£ç¡®ä½¿ç”¨ä¸é‡Šæ”¾
- å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œä¸­æ–­ã€AIæœåŠ¡è¶…æ—¶ã€æˆæƒå¤±è´¥

**Betaé˜¶æ®µæ–°å¢ï¼š**

- åç«¯å‡†å¤‡å›ºå®šçš„"ç¤ºä¾‹åŒ…"æ•°æ®ï¼ˆ3ä¸ªèŠ‚ç‚¹ + 2-3ä¸ªé¢„è®¾å…³è”ï¼‰
- ç¤ºä¾‹åŒ…å¯¼å…¥éœ€ä¸ºåŸå­æ“ä½œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- è®¢é˜…æ¶ˆæ¯æ¨¡æ¿IDçš„é…ç½®ä¸ç®¡ç†

**æ€§èƒ½è¦æ±‚ï¼š**

- æ¬¢è¿é¡µåŠ¨ç”»ï¼š60fpsæµç•…åº¦
- AIå¤„ç†æ€»è€—æ—¶ï¼šP95 < 5ç§’
- å°ç¨‹åºåŒ…ä½“ç§¯ï¼š< 2MBï¼ˆåˆ†åŒ…åŠ è½½ï¼‰

---

#### **3.2.5 å¼‚å¸¸å¤„ç†**

| å¼‚å¸¸åœºæ™¯               | å¤„ç†ç­–ç•¥                     | ç”¨æˆ·æç¤º                                              |
| ---------------------- | ---------------------------- | ----------------------------------------------------- |
| **ç”¨æˆ·æ‹’ç»å¾®ä¿¡æˆæƒ**   | é˜»æ–­æµç¨‹ï¼Œæ˜¾ç¤ºæˆæƒå¿…è¦æ€§è¯´æ˜ | "Weaveéœ€è¦è·å–ä½ çš„åŸºæœ¬ä¿¡æ¯æ¥ä¿å­˜ä½ çš„æ€æƒ³ï¼Œè¯·å…è®¸æˆæƒ" |
| **ç”¨æˆ·æ‹’ç»éº¦å…‹é£æƒé™** | é˜»æ–­æµç¨‹ï¼Œå¼•å¯¼å»è®¾ç½®é¡µå¼€å¯   | "è¯­éŸ³è¾“å…¥æ˜¯Weaveçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè¯·åœ¨è®¾ç½®ä¸­å¼€å¯éº¦å…‹é£æƒé™" |
| **å½•éŸ³æ—¶é•¿<2ç§’**       | ä¸å‘é€è¯·æ±‚ï¼Œæç¤ºé‡æ–°å½•å…¥     | "è¯´è¯æ—¶é—´å¤ªçŸ­å•¦ï¼Œé•¿æŒ‰éº¦å…‹é£é‡æ–°è¯´ä¸€éå§"              |
| **ASRæœåŠ¡å¤±è´¥**        | ä¿å­˜ç©ºç™½èŠ‚ç‚¹ï¼Œæç¤ºç¨åé‡è¯•   | "è¯­éŸ³è¯†åˆ«æš‚æ—¶å‡ºé”™ï¼Œè¯·ç¨ååœ¨èŠ‚ç‚¹ä¸­é‡æ–°ç¼–è¾‘"            |
| **LLMå¤„ç†è¶…æ—¶**        | ä½¿ç”¨åŸå§‹ASRæ–‡æœ¬åˆ›å»ºèŠ‚ç‚¹      | "AIæ­£åœ¨åŠªåŠ›ç†è§£ä¸­...å·²ä¸ºä½ ä¿å­˜åŸå§‹å†…å®¹"               |
| **ç½‘ç»œå®Œå…¨æ–­å¼€**       | æœ¬åœ°ç¼“å­˜ï¼Œå¾…ç½‘ç»œæ¢å¤è‡ªåŠ¨ä¸Šä¼  | "ç½‘ç»œä¼¼ä¹æ–­å¼€äº†ï¼Œå†…å®¹å·²ä¿å­˜æœ¬åœ°ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥"      |

---

#### **3.2.6 æ•°æ®åŸ‹ç‚¹**

| äº‹ä»¶åç§°                    | è§¦å‘æ—¶æœº           | å…³é”®å‚æ•°                          |
| --------------------------- | ------------------ | --------------------------------- |
| `onboarding_start`          | ç”¨æˆ·æ‰“å¼€æ¬¢è¿é¡µ     | `timestamp`, `channel_source`     |
| `auth_wechat_click`         | ç‚¹å‡»"å¼€å¯ç»‡å¿µä¹‹æ—…" | -                                 |
| `auth_wechat_success`       | å¾®ä¿¡æˆæƒæˆåŠŸ       | `user_id`, `duration`             |
| `auth_wechat_fail`          | å¾®ä¿¡æˆæƒå¤±è´¥       | `error_code`, `error_msg`         |
| `auth_mic_request`          | è¯·æ±‚éº¦å…‹é£æƒé™     | -                                 |
| `auth_mic_success`          | éº¦å…‹é£æˆæƒæˆåŠŸ     | -                                 |
| `auth_mic_fail`             | éº¦å…‹é£æˆæƒå¤±è´¥     | -                                 |
| `first_voice_record_start`  | å¼€å§‹é¦–æ¬¡å½•éŸ³       | -                                 |
| `first_voice_record_end`    | ç»“æŸé¦–æ¬¡å½•éŸ³       | `duration_seconds`                |
| `first_node_create_success` | é¦–ä¸ªèŠ‚ç‚¹åˆ›å»ºæˆåŠŸ   | `node_id`, `processing_time`      |
| `first_node_create_fail`    | é¦–ä¸ªèŠ‚ç‚¹åˆ›å»ºå¤±è´¥   | `error_type`                      |
| `sample_pack_show`          | ç¤ºä¾‹åŒ…å¼¹çª—å±•ç¤º     | `version` (Beta)                  |
| `sample_pack_import`        | ç”¨æˆ·å¯¼å…¥ç¤ºä¾‹åŒ…     | `version` (Beta)                  |
| `sample_pack_dismiss`       | ç”¨æˆ·å…³é—­ç¤ºä¾‹åŒ…å¼¹çª— | `version` (Beta)                  |
| `subscribe_msg_request`     | è¯·æ±‚è®¢é˜…æ¶ˆæ¯æƒé™   | `version` (Beta)                  |
| `subscribe_msg_success`     | è®¢é˜…æ¶ˆæ¯æˆæƒæˆåŠŸ   | `version` (Beta)                  |
| `onboarding_complete`       | è¿›å…¥ä¸»ç•Œé¢         | `total_duration`, `nodes_created` |

---

#### **3.2.7 APIå¥‘çº¦**

**æ¥å£1ï¼šåˆ›å»ºé¦–ä¸ªæ™ºæ…§èŠ‚ç‚¹ï¼ˆè¯­éŸ³ï¼‰**

```yaml
åç§°: POST /api/v1/onboarding/first-node
æ–¹æ³•: POST
è®¤è¯: Bearer Token (å¾®ä¿¡ç™»å½•åè·å–)

è¯·æ±‚ä½“ (Request Body):
{
  "raw_text": "ç”¨æˆ·è¯­éŸ³è½¬å½•çš„åŸå§‹æ–‡æœ¬",
  "audio_duration": 15.5,  // ç§’
  "audio_url": "å¯é€‰ï¼Œäº‘å­˜å‚¨é“¾æ¥"
}

æˆåŠŸå“åº” (201 Created):
{
  "status": "success",
  "node": {
    "node_id": "uuid-xxxx",
    "title": "AIç”Ÿæˆçš„æ ‡é¢˜",
    "content": "AIç²¾ç‚¼åçš„å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰",
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"],
    "created_at": "2025-10-20T10:30:00Z"
  },
  "ai_processing_time": 3.2  // ç§’
}

é”™è¯¯å“åº”:
400 Bad Request:
{
  "error": "invalid_input",
  "message": "raw_textä¸èƒ½ä¸ºç©º"
}

503 Service Unavailable:
{
  "error": "ai_service_unavailable",
  "message": "AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¿å­˜åŸå§‹è¾“å…¥",
  "node_id": "uuid-xxxx"  // ä»ç„¶åˆ›å»ºèŠ‚ç‚¹ï¼Œä½†å†…å®¹ä¸ºåŸå§‹æ–‡æœ¬
}
```

**æ¥å£2ï¼šå¯¼å…¥ç¤ºä¾‹åŒ…ï¼ˆBetaç‰ˆï¼‰**

```yaml
åç§°: POST /api/v1/onboarding/import-sample-pack
æ–¹æ³•: POST
è®¤è¯: Bearer Token

è¯·æ±‚ä½“:
{
  "pack_version": "v1.0"  // ç¤ºä¾‹åŒ…ç‰ˆæœ¬å·
}

æˆåŠŸå“åº” (200 OK):
{
  "status": "success",
  "imported_nodes": [
    {
      "node_id": "uuid-1",
      "title": "è´¹æ›¼å­¦ä¹ æ³•"
    },
    {
      "node_id": "uuid-2",
      "title": "é—´éš”é‡å¤åŸç†"
    },
    {
      "node_id": "uuid-3",
      "title": "ä¸»åŠ¨å¬å›æŠ€å·§"
    }
  ],
  "resonances_created": 2  // åˆ›å»ºçš„å…³è”æ•°
}

é”™è¯¯å“åº”:
409 Conflict:
{
  "error": "already_imported",
  "message": "ä½ å·²ç»å¯¼å…¥è¿‡ç¤ºä¾‹åŒ…äº†"
}
```

---

### **3.2.8 éªŒæ”¶æ ‡å‡† (Acceptance Criteria)**

**Alphaç‰ˆæœ¬ï¼š**

- [ ] ç”¨æˆ·èƒ½åœ¨60ç§’å†…å®Œæˆä»æ‰“å¼€åˆ°åˆ›å»ºé¦–ä¸ªèŠ‚ç‚¹
- [ ] é¦–æ¬¡èŠ‚ç‚¹åˆ›å»ºç‡ â‰¥ 50%
- [ ] éº¦å…‹é£æƒé™è·å–ç‡ â‰¥ 90%
- [ ] AIå¤„ç†æˆåŠŸç‡ â‰¥ 95%
- [ ] æ‰€æœ‰åŠ¨ç”»æµç•…ï¼Œæ— æ˜æ˜¾å¡é¡¿

**Betaç‰ˆæœ¬ï¼š**

- [ ] ç¤ºä¾‹åŒ…å¯¼å…¥æˆåŠŸç‡ = 100%ï¼ˆæŠ€æœ¯å±‚é¢ï¼‰
- [ ] ç¤ºä¾‹åŒ…æ¥å—ç‡ â‰¥ 30%ï¼ˆç”¨æˆ·è‡ªæ„¿å¯¼å…¥çš„æ¯”ä¾‹ï¼‰
- [ ] è®¢é˜…æ¶ˆæ¯æˆæƒç‡ â‰¥ 40%
- [ ] å¯¼å…¥ç¤ºä¾‹åŒ…çš„ç”¨æˆ·ï¼Œæ¬¡æ—¥ç•™å­˜ç‡æ¯”æœªå¯¼å…¥ç”¨æˆ·é«˜15%+

---

ç°åœ¨ç»§ç»­ç¬¬ä¸‰ç« çš„å…¶ä»–ç”¨æˆ·æ•…äº‹...

---

### **3.3 US2: è¯­éŸ³è¾“å…¥ - è®©æ€æƒ³è‡ªç”±æµæ·Œ**

#### **3.3.1 åŠŸèƒ½ç›®æ ‡**

- æä¾›æœ€ä½æ‘©æ“¦çš„ä¿¡æ¯æ•æ‰æ–¹å¼
- éªŒè¯ç”¨æˆ·æ˜¯å¦æ„¿æ„é«˜é¢‘ä½¿ç”¨è¯­éŸ³è®°å½•ï¼ˆå‘¨å‡3æ¬¡+ï¼‰
- é€šè¿‡AIå°†å£è¯­åŒ–è¾“å…¥è½¬åŒ–ä¸ºç»“æ„åŒ–çŸ¥è¯†

---

#### **3.3.2 æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**

æ ¹æ®è¯„å®¡å»ºè®®ï¼Œé‡‡ç”¨**æ¸è¿›å¼æŠ€æœ¯æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ                   | å®ç°æ–¹å¼               | ç”¨æˆ·ä½“éªŒ               | æŠ€æœ¯å¤æ‚åº¦ | æˆæœ¬ | MVPé€‰æ‹© |
| ---------------------- | ---------------------- | ---------------------- | ---------- | ---- | ------- |
| **æ–¹æ¡ˆAï¼šå®æ—¶æµå¼ASR** | WebSocket + æµå¼è¯†åˆ«   | â­â­â­â­â­<br/>å®æ—¶çœ‹åˆ°æ–‡å­— | â­â­â­â­â­      | é«˜   | âŒ V1.1  |
| **æ–¹æ¡ˆBï¼šæ‰¹é‡å¤„ç†ASR** | å½•éŸ³å®Œæˆåä¸Šä¼ å¤„ç†     | â­â­â­â­<br/>3-5ç§’å»¶è¿Ÿ     | â­â­â­        | ä¸­   | âœ… V1.0  |
| **æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆ**    | çŸ­éŸ³é¢‘å®æ—¶ï¼Œé•¿éŸ³é¢‘æ‰¹é‡ | â­â­â­â­                   | â­â­â­â­       | ä¸­é«˜ | V1.2    |

**V1.0å†³ç­–ï¼šé€‰æ‹©æ–¹æ¡ˆBï¼ˆæ‰¹é‡å¤„ç†ï¼‰**

**ç†ç”±ï¼š**

1. 3-5ç§’çš„å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´ï¼ˆç”¨æˆ·é¢„æœŸAIéœ€è¦"æ€è€ƒ"ï¼‰
2. æŠ€æœ¯å®ç°ç®€å•ï¼Œå¼€å‘å‘¨æœŸçŸ­2-3å‘¨
3. æˆæœ¬èŠ‚çœçº¦40%ï¼ˆæŒ‰è°ƒç”¨é‡è®¡è´¹ vs æŒ‰è¿æ¥æ—¶é•¿è®¡è´¹ï¼‰
4. è¶³ä»¥éªŒè¯æ ¸å¿ƒå‡è®¾ï¼ˆç”¨æˆ·æ˜¯å¦æ„¿æ„ç”¨è¯­éŸ³è¾“å…¥ï¼‰

---

#### **3.3.3 é€»è¾‘æµç¨‹**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å°ç¨‹åºå‰ç«¯
    participant API as åç«¯API
    participant ASR as ASRæœåŠ¡
    participant LLM as LLMæœåŠ¡
    participant DB as æ•°æ®åº“

    U->>F: é•¿æŒ‰éº¦å…‹é£æŒ‰é’®
    F->>F: å¼€å§‹å½•éŸ³ (wx.startRecord)
    F->>U: æ˜¾ç¤ºå½•éŸ³ä¸­åŠ¨ç”»
    
    U->>F: æ¾å¼€æŒ‰é’®
    F->>F: åœæ­¢å½•éŸ³ï¼Œè·å–ä¸´æ—¶æ–‡ä»¶
    F->>U: æ˜¾ç¤º"æ­£åœ¨ç¼–ç»‡..."åŠ¨ç”»
    
    F->>API: POST /nodes/voice<br/>{temp_file_path}
    API->>ASR: ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
    ASR-->>API: è¿”å›è¯†åˆ«æ–‡æœ¬
    
    API->>LLM: è°ƒç”¨ç²¾ç‚¼Prompt<br/>{raw_text}
    LLM-->>API: è¿”å›ç»“æ„åŒ–JSON
    
    API->>DB: ä¿å­˜æ™ºæ…§èŠ‚ç‚¹
    DB-->>API: è¿”å›node_id
    
    API-->>F: è¿”å›èŠ‚ç‚¹å¯¹è±¡
    F->>U: å±•ç¤ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹
```

---

#### **3.3.4 ç•Œé¢ä¸äº¤äº’**

**ä¸»ç•Œé¢ - è¯­éŸ³å…¥å£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< ç»‡å¿µ]         [ğŸ””]          â”‚  â† Header
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“Œ æ™ºæ…§èŠ‚ç‚¹æ ‡é¢˜            â”‚ â”‚
â”‚  â”‚ èŠ‚ç‚¹å†…å®¹é¢„è§ˆ...            â”‚ â”‚  â† èŠ‚ç‚¹åˆ—è¡¨
â”‚  â”‚ #æ ‡ç­¾  Â· 2å°æ—¶å‰           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“Œ å¦ä¸€ä¸ªèŠ‚ç‚¹              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚         [ç©ºçŠ¶æ€å¼•å¯¼]            â”‚  â† æ— èŠ‚ç‚¹æ—¶
â”‚                                 â”‚
â”‚                                 â”‚
â”‚                  ğŸ¤ â† æ‚¬æµ®æŒ‰é’®  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- æ‚¬æµ®æŒ‰é’®ï¼šå³ä¸‹è§’ï¼Œè·åº•éƒ¨80pxï¼Œè·å³ä¾§20px
- å°ºå¯¸ï¼š64x64pxï¼Œåœ†å½¢
- é¢œè‰²ï¼šçµæ„Ÿç´« (#A78BFA)
- é˜´å½±ï¼š0 4px 12px rgba(167, 139, 250, 0.4)
- ç‚¹å‡»æ•ˆæœï¼šç¼©æ”¾åŠ¨ç”» (scale 0.95)
```

**å½•éŸ³ä¸­ç•Œé¢:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å…¨å±æ¨¡æ€è¦†ç›–å±‚           â”‚
â”‚      (åŠé€æ˜æ·±è‰²èƒŒæ™¯)           â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚      è¯´å‡ºæ­¤åˆ»çš„æƒ³æ³•...           â”‚
â”‚                                 â”‚
â”‚         ğŸ¤                      â”‚
â”‚      (çº¢è‰²è„‰å†²åŠ¨ç”»)             â”‚
â”‚                                 â”‚
â”‚      [00:15 / 01:00]            â”‚  â† å½•éŸ³æ—¶é•¿
â”‚                                 â”‚
â”‚    é•¿æŒ‰è¯´è¯ï¼Œæ¾å¼€å®Œæˆ           â”‚
â”‚                                 â”‚
â”‚      [Ã— å–æ¶ˆ]                   â”‚  â† ä¸Šæ»‘å–æ¶ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- é•¿æŒ‰éº¦å…‹é£ï¼šå¼€å§‹å½•éŸ³ï¼Œå…¨å±æ¨¡æ€å±•å¼€
- æŒç»­æŒ‰ä½ï¼šå½•éŸ³è¿›è¡Œä¸­ï¼Œæ˜¾ç¤ºæ—¶é•¿
- ä¸Šæ»‘æ‰‹æŒ‡ï¼šå–æ¶ˆæœ¬æ¬¡å½•éŸ³
- æ¾å¼€æ‰‹æŒ‡ï¼šç»“æŸå½•éŸ³ï¼Œå¼€å§‹å¤„ç†
- è¶…è¿‡55ç§’ï¼šéœ‡åŠ¨æç¤ºï¼Œå€’è®¡æ—¶æ˜¾ç¤º
- è¾¾åˆ°60ç§’ï¼šè‡ªåŠ¨ç»“æŸå½•éŸ³
```

**AIå¤„ç†ä¸­ç•Œé¢:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å…¨å±æ¨¡æ€è¦†ç›–å±‚           â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚     [ç¼–ç»‡åŠ¨ç”» - Lottie]         â”‚
â”‚                                 â”‚
â”‚      æ­£åœ¨ç¼–ç»‡æ€æƒ³...            â”‚
â”‚                                 â”‚
â”‚      [è¿›åº¦æŒ‡ç¤ºå™¨]               â”‚
â”‚      â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘ 60%            â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿›åº¦é˜¶æ®µï¼š
1. "æ­£åœ¨è¯†åˆ«è¯­éŸ³..." (0-40%)
2. "æ­£åœ¨ç²¾ç‚¼å†…å®¹..." (40-80%)
3. "æ­£åœ¨ç”ŸæˆèŠ‚ç‚¹..." (80-100%)

è¶…æ—¶å¤„ç†ï¼š
- å¦‚æœ5ç§’æœªå®Œæˆï¼Œæ˜¾ç¤º"AIæ­£åœ¨åŠªåŠ›æ€è€ƒ..."
- å¦‚æœ10ç§’æœªå®Œæˆï¼Œæ˜¾ç¤º"ç½‘ç»œä¼¼ä¹æœ‰ç‚¹æ…¢..."
- å¦‚æœ15ç§’æœªå®Œæˆï¼Œé™çº§å¤„ç†ï¼ˆè§å¼‚å¸¸å¤„ç†ï¼‰
```

---

#### **3.3.5 æŠ€æœ¯å®ç°ç»†èŠ‚**

**å‰ç«¯å½•éŸ³å®ç°ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰:**

```javascript
// å½•éŸ³ç®¡ç†å™¨å•ä¾‹
const recorderManager = wx.getRecorderManager();

// å½•éŸ³é…ç½®
const recorderOptions = {
  duration: 60000,        // æœ€å¤§æ—¶é•¿60ç§’
  sampleRate: 16000,      // é‡‡æ ·ç‡16kHzï¼ˆæ»¡è¶³ASRè¦æ±‚ï¼‰
  numberOfChannels: 1,    // å•å£°é“
  encodeBitRate: 48000,   // æ¯”ç‰¹ç‡
  format: 'mp3'           // æ ¼å¼
};

// å¼€å§‹å½•éŸ³
function startRecording() {
  recorderManager.start(recorderOptions);
  
  // ç›‘å¬å½•éŸ³å¼€å§‹
  recorderManager.onStart(() => {
    console.log('å½•éŸ³å¼€å§‹');
    // æ˜¾ç¤ºå½•éŸ³UI
  });
  
  // ç›‘å¬å½•éŸ³ç»“æŸ
  recorderManager.onStop((res) => {
    const { tempFilePath, duration } = res;
    // ä¸Šä¼ å¹¶å¤„ç†
    uploadVoiceNode(tempFilePath, duration);
  });
  
  // ç›‘å¬å½•éŸ³é”™è¯¯
  recorderManager.onError((err) => {
    console.error('å½•éŸ³å¤±è´¥', err);
    wx.showToast({
      title: 'å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    });
  });
}

// åœæ­¢å½•éŸ³
function stopRecording() {
  recorderManager.stop();
}

// ä¸Šä¼ è¯­éŸ³èŠ‚ç‚¹
async function uploadVoiceNode(filePath, duration) {
  try {
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    showProcessingAnimation();
    
    // ä¸Šä¼ æ–‡ä»¶åˆ°äº‘å­˜å‚¨
    const audioUrl = await uploadToCloud(filePath);
    
    // è°ƒç”¨åç«¯API
    const res = await wx.request({
      url: API_BASE + '/nodes/voice',
      method: 'POST',
      header: {
        'Authorization': 'Bearer ' + getToken()
      },
      data: {
        audio_url: audioUrl,
        duration: duration / 1000  // è½¬æ¢ä¸ºç§’
      },
      timeout: 15000  // 15ç§’è¶…æ—¶
    });
    
    if (res.statusCode === 201) {
      // æˆåŠŸï¼Œå±•ç¤ºèŠ‚ç‚¹
      showNewNode(res.data.node);
    } else {
      throw new Error('åˆ›å»ºå¤±è´¥');
    }
    
  } catch (error) {
    // é”™è¯¯å¤„ç†
    handleCreateNodeError(error);
  } finally {
    hideProcessingAnimation();
  }
}
```

**åç«¯APIå®ç°ï¼ˆPython FastAPIç¤ºä¾‹ï¼‰:**

```python
@router.post("/api/v1/nodes/voice")
async def create_voice_node(
    audio_url: str,
    duration: float,
    current_user: User = Depends(get_current_user),
    asr_service: ASRService = Depends(),
    llm_service: LLMService = Depends(),
    db: Session = Depends(get_db)
):
    """
    åˆ›å»ºè¯­éŸ³æ™ºæ…§èŠ‚ç‚¹
    """
    try:
        # 1. ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
        audio_file = await download_file(audio_url)
        
        # 2. è°ƒç”¨ASRæœåŠ¡
        raw_text = await asr_service.transcribe(
            audio_file,
            language='zh-CN'
        )
        
        if not raw_text or len(raw_text) < 5:
            raise ValueError("è¯­éŸ³è¯†åˆ«ç»“æœè¿‡çŸ­")
        
        # 3. è°ƒç”¨LLMç²¾ç‚¼
        refined_data = await llm_service.refine_content(
            raw_text=raw_text,
            user_id=current_user.id  # ç”¨äºä¸ªæ€§åŒ–
        )
        
        # 4. åˆ›å»ºèŠ‚ç‚¹
        node = Node(
            user_id=current_user.id,
            title=refined_data['title'],
            content=refined_data['content'],
            tags=refined_data['tags'],
            source_type='voice',
            raw_input={
                'text': raw_text,
                'audio_url': audio_url,
                'duration': duration
            },
            memory_stats=init_memory_stats()  # åˆå§‹åŒ–SM-2å‚æ•°
        )
        
        db.add(node)
        db.commit()
        db.refresh(node)
        
        # 5. å¼‚æ­¥è§¦å‘"æ€æƒ³å…±é¸£"åˆ†æ
        asyncio.create_task(
            find_resonances(node.id, current_user.id)
        )
        
        # 6. è®°å½•åŸ‹ç‚¹
        analytics.track(
            user_id=current_user.id,
            event='node_created',
            properties={
                'source_type': 'voice',
                'duration': duration,
                'processing_time': time.time() - start_time
            }
        )
        
        return {
            "status": "success",
            "node": node.to_dict()
        }
        
    except ASRError as e:
        # ASRæœåŠ¡å¤±è´¥ï¼Œé™çº§å¤„ç†
        logger.error(f"ASR failed: {e}")
        return await create_fallback_node(
            user_id=current_user.id,
            audio_url=audio_url,
            error_msg="è¯­éŸ³è¯†åˆ«å¤±è´¥"
        )
    
    except LLMError as e:
        # LLMæœåŠ¡å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
        logger.error(f"LLM failed: {e}")
        return await create_simple_node(
            user_id=current_user.id,
            raw_text=raw_text,
            audio_url=audio_url
        )
```

---

#### **3.3.6 AIæœåŠ¡æŠ€æœ¯é€‰å‹**

æ ¹æ®ç¬¬ä¹ç« çš„æˆæœ¬åˆ†æï¼ŒV1.0é€‰æ‹©ï¼š

**ASRæœåŠ¡ï¼šé˜¿é‡Œäº‘å®æ—¶è¯­éŸ³è¯†åˆ«**

| å‚æ•°         | é…ç½®         | è¯´æ˜               |
| ------------ | ------------ | ------------------ |
| **æœåŠ¡å•†**   | é˜¿é‡Œäº‘       | å›½å†…åˆè§„ï¼Œç¨³å®šæ€§é«˜ |
| **æ¨¡å‹**     | é€šç”¨ä¸­æ–‡è¯†åˆ« | æ”¯æŒ16kHzé‡‡æ ·ç‡    |
| **è®¡è´¹æ–¹å¼** | æŒ‰æ—¶é•¿è®¡è´¹   | Â¥0.039/åˆ†é’Ÿ        |
| **å‡†ç¡®ç‡**   | >90%         | æ ‡å‡†å£éŸ³           |
| **å»¶è¿Ÿ**     | <2ç§’         | æ‰¹é‡å¤„ç†æ¨¡å¼       |

**é…ç½®ç¤ºä¾‹ï¼ˆPython SDKï¼‰:**

```python
from aliyunsdkcore.client import AcsClient
from aliyunsdkcore.request import CommonRequest

class AliyunASRService:
    def __init__(self, access_key, access_secret):
        self.client = AcsClient(access_key, access_secret, 'cn-shanghai')
    
    async def transcribe(self, audio_file_path, language='zh-CN'):
        """
        è¯­éŸ³è½¬æ–‡æœ¬
        """
        # ä¸Šä¼ åˆ°OSS
        audio_url = upload_to_oss(audio_file_path)
        
        # æäº¤è¯†åˆ«ä»»åŠ¡
        request = CommonRequest()
        request.set_domain('nls-meta.cn-shanghai.aliyuncs.com')
        request.set_version('2019-02-28')
        request.set_action_name('CreateAsrTask')
        request.add_query_param('FileUrl', audio_url)
        request.add_query_param('Language', language)
        
        response = self.client.do_action_with_exception(request)
        task_id = json.loads(response)['TaskId']
        
        # è½®è¯¢ç»“æœï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰
        for i in range(10):
            await asyncio.sleep(0.5)
            result = self.get_task_result(task_id)
            if result['Status'] == 'SUCCESS':
                return result['Result']
        
        raise ASRError("ASR timeout")
```

---

### **3.4 US3: æˆªå›¾è¾“å…¥ - æ•æ‰è§†è§‰ä¸­çš„æ™ºæ…§**

#### **3.4.1 åŠŸèƒ½ç›®æ ‡**

- æä¾›ç¬¬äºŒç§æ ¸å¿ƒçš„ä½æ‘©æ“¦è¾“å…¥æ–¹å¼ï¼ˆè¦†ç›–é˜…è¯»åœºæ™¯ï¼‰
- é€šè¿‡OCR+LLMå°†å›¾ç‰‡ä¸­çš„ä¿¡æ¯è½¬åŒ–ä¸ºç»“æ„åŒ–çŸ¥è¯†
- éªŒè¯å¤šæ¨¡æ€è¾“å…¥å¯¹ç”¨æˆ·ç•™å­˜çš„æå‡æ•ˆæœ

**Betaé˜¶æ®µå‘å¸ƒ**ï¼ˆUS2éªŒè¯é€šè¿‡åå†ä¸Šçº¿ï¼‰

---

#### **3.4.2 æ”¯æŒçš„å›¾ç‰‡ç±»å‹**

| å›¾ç‰‡ç±»å‹             | OCRå‡†ç¡®ç‡é¢„æœŸ | å¤„ç†ç­–ç•¥         | ä¼˜å…ˆçº§       |
| -------------------- | ------------- | ---------------- | ------------ |
| **æˆªå›¾æ–‡å­—**         | >90%          | æ ‡å‡†OCR          | P0           |
| **ä¹¦ç±æ‹ç…§**         | >85%          | OCR + é€è§†çŸ«æ­£   | P0           |
| **PPT/æ¼”ç¤ºæ–‡ç¨¿**     | >90%          | OCR + ç‰ˆå¼åˆ†æ   | P1           |
| **æ‰‹å†™ç¬”è®°**         | >60%          | æ‰‹å†™è¯†åˆ«OCR      | P2 (V1.1)    |
| **å›¾è¡¨/ä¿¡æ¯å›¾**      | >70%          | OCR + ç»“æ„åŒ–ç†è§£ | P2 (V1.1)    |
| **çº¯å›¾ç‰‡ï¼ˆæ— æ–‡å­—ï¼‰** | N/A           | æš‚ä¸æ”¯æŒ         | Out of scope |

---

#### **3.4.3 é€»è¾‘æµç¨‹**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å°ç¨‹åºå‰ç«¯
    participant API as åç«¯API
    participant OCR as OCRæœåŠ¡
    participant LLM as LLMæœåŠ¡
    participant DB as æ•°æ®åº“

    U->>F: ç‚¹å‡»[+]æŒ‰é’®
    F->>U: æ˜¾ç¤ºé€‰é¡¹ï¼šæ‹ç…§/ä»ç›¸å†Œé€‰æ‹©
    
    U->>F: é€‰æ‹©å›¾ç‰‡
    F->>F: å›¾ç‰‡é¢„å¤„ç†ï¼ˆå‹ç¼©ã€æ—‹è½¬çŸ«æ­£ï¼‰
    F->>U: æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ + ç¡®è®¤æŒ‰é’®
    
    U->>F: ç¡®è®¤ä¸Šä¼ 
    F->>U: æ˜¾ç¤º"æ­£åœ¨è¯†åˆ«..."åŠ¨ç”»
    
    F->>API: POST /nodes/image<br/>multipart/form-data
    API->>OCR: ä¸Šä¼ å›¾ç‰‡
    OCR-->>API: è¿”å›è¯†åˆ«æ–‡æœ¬ + ç½®ä¿¡åº¦
    
    alt OCRç½®ä¿¡åº¦ > 0.7
        API->>LLM: è°ƒç”¨ç²¾ç‚¼Prompt
        LLM-->>API: è¿”å›ç»“æ„åŒ–JSON
    else OCRç½®ä¿¡åº¦ â‰¤ 0.7
        API->>API: ä»…ä¿å­˜åŸå§‹OCRæ–‡æœ¬
        API->>U: æç¤º"è¯†åˆ«å¯èƒ½ä¸å‡†ç¡®ï¼Œè¯·æ£€æŸ¥"
    end
    
    API->>DB: ä¿å­˜æ™ºæ…§èŠ‚ç‚¹ + åŸå§‹å›¾ç‰‡
    DB-->>API: è¿”å›node_id
    
    API-->>F: è¿”å›èŠ‚ç‚¹å¯¹è±¡
    F->>U: å±•ç¤ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹
```

---

#### **3.4.4 ç•Œé¢ä¸äº¤äº’**

**ä¸»ç•Œé¢ - å›¾ç‰‡å…¥å£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< ç»‡å¿µ]         [ğŸ””]          â”‚
â”‚                                 â”‚
â”‚  [æ™ºæ…§èŠ‚ç‚¹åˆ—è¡¨]                 â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚                ğŸ¤  â† ä¸»æ‚¬æµ®æŒ‰é’®â”‚
â”‚                [+] â† æ¬¡æ‚¬æµ®æŒ‰é’®â”‚  
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- ç‚¹å‡»[+]æŒ‰é’®ï¼šå±•å¼€æ“ä½œèœå•
- èœå•åŒ…å«ï¼šğŸ“· æ‹ç…§ã€ğŸ–¼ï¸ ä»ç›¸å†Œé€‰æ‹©
- èœå•å±•å¼€åŠ¨ç”»ï¼šä»ä¸‹å‘ä¸Šæ»‘å…¥
```

**å›¾ç‰‡é€‰æ‹©æ“ä½œèœå•:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“·  æ‹ç…§                  â”‚ â”‚  â† è°ƒç”¨ç›¸æœº
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  ğŸ–¼ï¸  ä»ç›¸å†Œé€‰æ‹©            â”‚ â”‚  â† è°ƒç”¨ç›¸å†Œ
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  ğŸ™ï¸  è¯­éŸ³è¾“å…¥              â”‚ â”‚  â† å¿«æ·å…¥å£
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  âœ•  å–æ¶ˆ                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- å¼¹å‡ºå¼åº•éƒ¨æ“ä½œæ 
- åœ†è§’é¡¶éƒ¨ï¼š24px
- èƒŒæ™¯ï¼šç™½è‰²ï¼Œå¸¦20%é€æ˜åº¦é»‘è‰²é®ç½©
- æ¯ä¸ªé€‰é¡¹é«˜åº¦ï¼š56px
- å›¾æ ‡å¤§å°ï¼š24x24px
```

**å›¾ç‰‡é¢„è§ˆä¸ç¡®è®¤:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è¿”å›]        [âœ“ ç¡®è®¤]       â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚   [å›¾ç‰‡é¢„è§ˆåŒºåŸŸ]           â”‚ â”‚
â”‚  â”‚   (å¯ç¼©æ”¾ã€æ—‹è½¬)           â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ æç¤ºï¼šç¡®ä¿æ–‡å­—æ¸…æ™°å¯è§       â”‚
â”‚                                 â”‚
â”‚  [ğŸ”„ é‡æ–°é€‰æ‹©]  [âœ“ ç¡®è®¤ä¸Šä¼ ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- æ”¯æŒæ‰‹åŠ¿ï¼šåŒæŒ‡ç¼©æ”¾ã€æ—‹è½¬
- å›¾ç‰‡è¿‡å¤§è‡ªåŠ¨å‹ç¼©ï¼ˆ<2MBï¼‰
- å›¾ç‰‡è¿‡æš—/è¿‡äº®æç¤ºç”¨æˆ·é‡æ‹
- æ”¯æŒå®æ—¶è£å‰ªï¼ˆæ¡†é€‰æ–‡å­—åŒºåŸŸï¼‰
```

**OCRè¯†åˆ«ä¸­ç•Œé¢:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚     [æ‰«æåŠ¨ç”» - æ‰«æçº¿æ•ˆæœ]      â”‚
â”‚                                 â”‚
â”‚     æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—...      â”‚
â”‚                                 â”‚
â”‚     [è¿›åº¦æŒ‡ç¤ºå™¨]                â”‚
â”‚     â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘ 50%             â”‚
â”‚                                 â”‚
â”‚  [ç¼©ç•¥å›¾é¢„è§ˆ]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿›åº¦é˜¶æ®µï¼š
1. "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡..." (0-30%)
2. "æ­£åœ¨è¯†åˆ«æ–‡å­—..." (30-70%)
3. "æ­£åœ¨ç²¾ç‚¼å†…å®¹..." (70-100%)

è¶…æ—¶å¤„ç†ï¼š
- å¦‚æœ8ç§’æœªå®Œæˆï¼Œæ˜¾ç¤º"å›¾ç‰‡è¾ƒå¤§ï¼Œè¯·ç¨å€™..."
- å¦‚æœ15ç§’æœªå®Œæˆï¼Œæç¤ºé™çº§å¤„ç†
```

**OCRç»“æœå±•ç¤ºï¼ˆä½ç½®ä¿¡åº¦åœºæ™¯ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Œ [AIç”Ÿæˆçš„æ ‡é¢˜]               â”‚
â”‚                                 â”‚
â”‚  [AIç²¾ç‚¼åçš„å†…å®¹]                â”‚
â”‚                                 â”‚
â”‚  âš ï¸ AIæç¤º                      â”‚
â”‚  è¯†åˆ«å¯èƒ½ä¸å¤Ÿå‡†ç¡®ï¼Œå»ºè®®æ£€æŸ¥åŸæ–‡  â”‚
â”‚                                 â”‚
â”‚  [æŸ¥çœ‹åŸå§‹å›¾ç‰‡] [æŸ¥çœ‹è¯†åˆ«æ–‡æœ¬]   â”‚
â”‚                                 â”‚
â”‚  #æ ‡ç­¾1 #æ ‡ç­¾2                  â”‚
â”‚                                 â”‚
â”‚  [ğŸ‘] [ğŸ‘]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **3.4.5 æŠ€æœ¯å®ç°ç»†èŠ‚**

**å‰ç«¯å›¾ç‰‡å¤„ç†ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰:**

```javascript
// é€‰æ‹©å›¾ç‰‡
function chooseImage(sourceType) {
  wx.chooseImage({
    count: 1,
    sizeType: ['compressed'],  // å‹ç¼©å›¾
    sourceType: [sourceType],  // 'camera' æˆ– 'album'
    success: (res) => {
      const tempFilePath = res.tempFilePaths[0];
      
      // é¢„å¤„ç†å›¾ç‰‡
      preprocessImage(tempFilePath);
    }
  });
}

// å›¾ç‰‡é¢„å¤„ç†
async function preprocessImage(filePath) {
  try {
    // 1. è·å–å›¾ç‰‡ä¿¡æ¯
    const info = await wx.getImageInfo({ src: filePath });
    
    // 2. æ£€æŸ¥å°ºå¯¸ï¼ˆè¿‡å¤§éœ€è¦å‹ç¼©ï¼‰
    if (info.width > 2000 || info.height > 2000) {
      filePath = await compressImage(filePath);
    }
    
    // 3. æ£€æŸ¥æ—‹è½¬ï¼ˆEXIFä¿¡æ¯çŸ«æ­£ï¼‰
    const orientation = await getImageOrientation(filePath);
    if (orientation !== 1) {
      filePath = await rotateImage(filePath, orientation);
    }
    
    // 4. æ£€æŸ¥æ¸…æ™°åº¦ï¼ˆæ¨¡ç³Šåº¦æ£€æµ‹ï¼‰
    const sharpness = await detectSharpness(filePath);
    if (sharpness < 0.5) {
      wx.showModal({
        title: 'å›¾ç‰‡å¯èƒ½ä¸å¤Ÿæ¸…æ™°',
        content: 'å»ºè®®é‡æ–°æ‹æ‘„ä»¥è·å¾—æ›´å¥½çš„è¯†åˆ«æ•ˆæœ',
        confirmText: 'é‡æ–°æ‹æ‘„',
        cancelText: 'ç»§ç»­ä½¿ç”¨'
      });
    }
    
    // 5. å±•ç¤ºé¢„è§ˆ
    showImagePreview(filePath);
    
  } catch (error) {
    console.error('å›¾ç‰‡é¢„å¤„ç†å¤±è´¥', error);
  }
}

// å‹ç¼©å›¾ç‰‡
function compressImage(filePath) {
  return new Promise((resolve, reject) => {
    wx.compressImage({
      src: filePath,
      quality: 80,  // å‹ç¼©è´¨é‡
      success: (res) => resolve(res.tempFilePath),
      fail: reject
    });
  });
}

// ä¸Šä¼ å›¾ç‰‡èŠ‚ç‚¹
async function uploadImageNode(filePath) {
  try {
    showProcessingAnimation('æ­£åœ¨è¯†åˆ«å›¾ç‰‡...');
    
    // ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    const imageUrl = await uploadToCloud(filePath);
    
    // è°ƒç”¨åç«¯API
    const res = await wx.request({
      url: API_BASE + '/nodes/image',
      method: 'POST',
      header: {
        'Authorization': 'Bearer ' + getToken(),
        'Content-Type': 'application/json'
      },
      data: {
        image_url: imageUrl
      },
      timeout: 20000  // 20ç§’è¶…æ—¶ï¼ˆOCRè¾ƒæ…¢ï¼‰
    });
    
    if (res.statusCode === 201) {
      showNewNode(res.data.node);
      
      // å¦‚æœç½®ä¿¡åº¦ä½ï¼Œæ˜¾ç¤ºæç¤º
      if (res.data.ocr_confidence < 0.7) {
        showLowConfidenceWarning();
      }
    } else {
      throw new Error('åˆ›å»ºå¤±è´¥');
    }
    
  } catch (error) {
    handleCreateNodeError(error);
  } finally {
    hideProcessingAnimation();
  }
}
```

---

**åç«¯APIå®ç°:**

```python
@router.post("/api/v1/nodes/image")
async def create_image_node(
    image_url: str,
    current_user: User = Depends(get_current_user),
    ocr_service: OCRService = Depends(),
    llm_service: LLMService = Depends(),
    db: Session = Depends(get_db)
):
    """
    åˆ›å»ºå›¾ç‰‡æ™ºæ…§èŠ‚ç‚¹
    """
    start_time = time.time()
    
    try:
        # 1. ä¸‹è½½å›¾ç‰‡
        image_file = await download_file(image_url)
        
        # 2. è°ƒç”¨OCRæœåŠ¡
        ocr_result = await ocr_service.recognize_text(
            image_file,
            language='zh-CN',
            detect_orientation=True  # è‡ªåŠ¨æ£€æµ‹æ–¹å‘
        )
        
        raw_text = ocr_result['text']
        confidence = ocr_result['confidence']
        
        if not raw_text or len(raw_text) < 10:
            raise ValueError("å›¾ç‰‡ä¸­æœªè¯†åˆ«åˆ°è¶³å¤Ÿçš„æ–‡å­—")
        
        # 3. æ ¹æ®ç½®ä¿¡åº¦å†³å®šå¤„ç†ç­–ç•¥
        if confidence > 0.7:
            # é«˜ç½®ä¿¡åº¦ï¼šè°ƒç”¨LLMç²¾ç‚¼
            refined_data = await llm_service.refine_content(
                raw_text=raw_text,
                user_id=current_user.id,
                context_hint="è¿™æ˜¯ä»å›¾ç‰‡ä¸­è¯†åˆ«çš„æ–‡å­—"
            )
        else:
            # ä½ç½®ä¿¡åº¦ï¼šç®€å•å¤„ç†
            refined_data = {
                'title': raw_text[:30] + '...',
                'content': raw_text,
                'tags': []
            }
        
        # 4. åˆ›å»ºèŠ‚ç‚¹
        node = Node(
            user_id=current_user.id,
            title=refined_data['title'],
            content=refined_data['content'],
            tags=refined_data['tags'],
            source_type='image',
            raw_input={
                'text': raw_text,
                'image_url': image_url,
                'ocr_confidence': confidence
            },
            memory_stats=init_memory_stats()
        )
        
        db.add(node)
        db.commit()
        db.refresh(node)
        
        # 5. å¼‚æ­¥è§¦å‘"æ€æƒ³å…±é¸£"
        asyncio.create_task(
            find_resonances(node.id, current_user.id)
        )
        
        # 6. åŸ‹ç‚¹
        analytics.track(
            user_id=current_user.id,
            event='node_created',
            properties={
                'source_type': 'image',
                'ocr_confidence': confidence,
                'text_length': len(raw_text),
                'processing_time': time.time() - start_time
            }
        )
        
        return {
            "status": "success",
            "node": node.to_dict(),
            "ocr_confidence": confidence,
            "warning": "low_confidence" if confidence < 0.7 else None
        }
        
    except OCRError as e:
        logger.error(f"OCR failed: {e}")
        raise HTTPException(
            status_code=422,
            detail="å›¾ç‰‡æ–‡å­—è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æ–‡å­—"
        )
    
    except Exception as e:
        logger.error(f"Image node creation failed: {e}")
        raise HTTPException(
            status_code=500,
            detail="åˆ›å»ºèŠ‚ç‚¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
        )
```

---

#### **3.4.6 OCRæœåŠ¡æŠ€æœ¯é€‰å‹**

æ ¹æ®ç¬¬ä¹ç« æˆæœ¬åˆ†æï¼ŒV1.0é€‰æ‹©ï¼š

**OCRæœåŠ¡ï¼šç™¾åº¦OCRé€šç”¨æ–‡å­—è¯†åˆ«ï¼ˆé«˜ç²¾åº¦ç‰ˆï¼‰**

| å‚æ•°         | é…ç½®                   | è¯´æ˜                      |
| ------------ | ---------------------- | ------------------------- |
| **æœåŠ¡å•†**   | ç™¾åº¦æ™ºèƒ½äº‘             | å›½å†…é¢†å…ˆï¼Œä¸­æ–‡æ•ˆæœå¥½      |
| **æ¨¡å‹**     | é€šç”¨æ–‡å­—è¯†åˆ«ï¼ˆé«˜ç²¾åº¦ï¼‰ | æ”¯æŒå€¾æ–œã€æ¨¡ç³Šæ–‡å­—        |
| **è®¡è´¹æ–¹å¼** | æŒ‰æ¬¡è®¡è´¹               | Â¥0.008/æ¬¡ï¼ˆå‰1000æ¬¡å…è´¹ï¼‰ |
| **å‡†ç¡®ç‡**   | >95%                   | å°åˆ·ä½“æ ‡å‡†åœºæ™¯            |
| **å»¶è¿Ÿ**     | <3ç§’                   | P95                       |
| **å¹¶å‘é™åˆ¶** | 10 QPS                 | æ»¡è¶³MVPéœ€æ±‚               |

**é…ç½®ç¤ºä¾‹ï¼ˆPython SDKï¼‰:**

```python
from aip import AipOcr

class BaiduOCRService:
    def __init__(self, app_id, api_key, secret_key):
        self.client = AipOcr(app_id, api_key, secret_key)
    
    async def recognize_text(
        self, 
        image_path: str,
        language: str = 'CHN_ENG',
        detect_orientation: bool = True
    ):
        """
        è¯†åˆ«å›¾ç‰‡æ–‡å­—
        """
        # è¯»å–å›¾ç‰‡
        with open(image_path, 'rb') as f:
            image_data = f.read()
        
        # è°ƒç”¨é«˜ç²¾åº¦OCR
        options = {
            'detect_direction': detect_orientation,
            'probability': True  # è¿”å›ç½®ä¿¡åº¦
        }
        
        result = self.client.accurate(image_data, options)
        
        if 'error_code' in result:
            raise OCRError(f"OCR failed: {result['error_msg']}")
        
        # è§£æç»“æœ
        words_result = result.get('words_result', [])
        
        if not words_result:
            raise OCRError("å›¾ç‰‡ä¸­æœªè¯†åˆ«åˆ°æ–‡å­—")
        
        # æå–æ–‡æœ¬å’Œç½®ä¿¡åº¦
        texts = []
        confidences = []
        
        for item in words_result:
            texts.append(item['words'])
            if 'probability' in item:
                confidences.append(item['probability']['average'])
        
        full_text = '\n'.join(texts)
        avg_confidence = sum(confidences) / len(confidences) if confidences else 0
        
        return {
            'text': full_text,
            'confidence': avg_confidence,
            'words_count': len(words_result)
        }
```

---

#### **3.4.7 å¼‚å¸¸å¤„ç†**

| å¼‚å¸¸åœºæ™¯                       | å¤„ç†ç­–ç•¥               | ç”¨æˆ·æç¤º                                   |
| ------------------------------ | ---------------------- | ------------------------------------------ |
| **å›¾ç‰‡æ— æ–‡å­—**                 | æ‹’ç»åˆ›å»ºèŠ‚ç‚¹           | "å›¾ç‰‡ä¸­æœªè¯†åˆ«åˆ°æ–‡å­—ï¼Œè¯·é‡æ–°é€‰æ‹©"           |
| **å›¾ç‰‡è¿‡å¤§ï¼ˆ>10MBï¼‰**          | è‡ªåŠ¨å‹ç¼©åä¸Šä¼          | "å›¾ç‰‡è¾ƒå¤§ï¼Œæ­£åœ¨å¤„ç†..."                    |
| **å›¾ç‰‡è¿‡å°ï¼ˆ<100KBä¸”å°ºå¯¸å°ï¼‰** | è­¦å‘Šä½†å…è®¸             | "å›¾ç‰‡å¯èƒ½è¿‡å°ï¼Œè¯†åˆ«æ•ˆæœå¯èƒ½ä¸ä½³"           |
| **å›¾ç‰‡æ¨¡ç³Š**                   | è­¦å‘Šä½†å…è®¸             | "å›¾ç‰‡å¯èƒ½ä¸å¤Ÿæ¸…æ™°ï¼Œå»ºè®®é‡æ‹"               |
| **OCRæœåŠ¡è¶…æ—¶**                | 3æ¬¡é‡è¯•åé™çº§          | "è¯†åˆ«æœåŠ¡ç¹å¿™ï¼Œå·²ä¿å­˜åŸå›¾ï¼Œç¨åå¯é‡æ–°è¯†åˆ«" |
| **OCRè¯†åˆ«ä¹±ç **                | ä¿å­˜åŸå›¾+ä¹±ç æ–‡æœ¬      | "è¯†åˆ«ç»“æœå¯èƒ½ä¸å‡†ç¡®ï¼Œè¯·æŸ¥çœ‹åŸå›¾"           |
| **ç½‘ç»œæ–­å¼€**                   | æœ¬åœ°ç¼“å­˜ï¼Œå¾…æ¢å¤åä¸Šä¼  | "ç½‘ç»œå·²æ–­å¼€ï¼Œå›¾ç‰‡å·²ä¿å­˜æœ¬åœ°"               |

---

#### **3.4.8 æ•°æ®åŸ‹ç‚¹**

| äº‹ä»¶åç§°                       | è§¦å‘æ—¶æœº         | å…³é”®å‚æ•°                                  |
| ------------------------------ | ---------------- | ----------------------------------------- |
| `image_upload_click`           | ç‚¹å‡»[+]æŒ‰é’®      | `source: 'camera' / 'album'`              |
| `image_selected`               | é€‰æ‹©å›¾ç‰‡æˆåŠŸ     | `file_size`, `dimensions`                 |
| `image_preview_confirm`        | ç¡®è®¤ä¸Šä¼          | `is_compressed`, `is_rotated`             |
| `image_ocr_start`              | å¼€å§‹OCRè¯†åˆ«      | `image_url`                               |
| `image_ocr_success`            | OCRæˆåŠŸ          | `confidence`, `text_length`, `duration`   |
| `image_ocr_fail`               | OCRå¤±è´¥          | `error_type`                              |
| `image_node_created`           | èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ     | `node_id`, `ocr_confidence`, `total_time` |
| `low_confidence_warning_shown` | æ˜¾ç¤ºä½ç½®ä¿¡åº¦è­¦å‘Š | `confidence`                              |
| `user_view_original_image`     | ç”¨æˆ·æŸ¥çœ‹åŸå›¾     | `node_id`                                 |

---

#### **3.4.9 éªŒæ”¶æ ‡å‡†**

**åŠŸèƒ½éªŒæ”¶ï¼š**

- [ ] ç”¨æˆ·èƒ½é€šè¿‡æ‹ç…§å’Œç›¸å†Œä¸¤ç§æ–¹å¼ä¸Šä¼ å›¾ç‰‡
- [ ] å›¾ç‰‡è‡ªåŠ¨å‹ç¼©è‡³<2MB
- [ ] æ”¯æŒå›¾ç‰‡æ—‹è½¬çŸ«æ­£
- [ ] OCRè¯†åˆ«æˆåŠŸç‡ â‰¥ 85%ï¼ˆæ ‡å‡†å°åˆ·ä½“ï¼‰
- [ ] å¤„ç†æ€»è€—æ—¶ P95 < 8ç§’

**ä½“éªŒéªŒæ”¶ï¼š**

- [ ] å›¾ç‰‡é¢„è§ˆç•Œé¢æµç•…ï¼Œæ”¯æŒç¼©æ”¾
- [ ] ä½ç½®ä¿¡åº¦åœºæ™¯æœ‰æ˜ç¡®æç¤º
- [ ] è¯†åˆ«å¤±è´¥æ—¶æœ‰å‹å¥½çš„é”™è¯¯æç¤º
- [ ] å¯æŸ¥çœ‹åŸå§‹å›¾ç‰‡

**æ•°æ®éªŒæ”¶ï¼š**

- [ ] å›¾ç‰‡è¾“å…¥ç”¨æˆ·å æ¯” â‰¥ 30%
- [ ] å›¾ç‰‡èŠ‚ç‚¹çš„å¤ä¹ å‚ä¸åº¦ â‰¥ è¯­éŸ³èŠ‚ç‚¹çš„80%

---

### **3.5 US4: æ€æƒ³å…±é¸£ - AIå‘ç°çŸ¥è¯†çš„éšç§˜è¿æ¥**

#### **3.5.1 åŠŸèƒ½ç›®æ ‡**

- è‡ªåŠ¨å‘ç°æ–°èŠ‚ç‚¹ä¸å†å²çŸ¥è¯†çš„å…³è”ï¼Œæå‡äº§å“çš„"é­”æ³•æ„Ÿ"
- å¸®åŠ©ç”¨æˆ·æ„å»ºçŸ¥è¯†ç½‘ç»œï¼Œè€Œéå­¤ç«‹çš„ä¿¡æ¯å­¤å²›
- éªŒè¯"AIè¿æ¥ä»·å€¼"å¯¹ç”¨æˆ·ç•™å­˜çš„æå‡æ•ˆæœ

**é‡è¦è°ƒæ•´ï¼ˆæ ¹æ®è¯„å®¡å»ºè®®ï¼‰ï¼š**

- **V1.0 MVP**: é‡‡ç”¨**å…³é”®è¯åŒ¹é… + TF-IDF**çš„è½»é‡çº§æ–¹æ¡ˆ
- **V1.1**: å‡çº§ä¸º**å‘é‡æ£€ç´¢ + LLMæ·±åº¦åˆ†æ**

---

#### **3.5.2 æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ                  | å®ç°æ–¹å¼              | å‡†ç¡®ç‡ | æˆæœ¬ | å¼€å‘å‘¨æœŸ | MVPé€‰æ‹© |
| --------------------- | --------------------- | ------ | ---- | -------- | ------- |
| **æ–¹æ¡ˆAï¼šå…³é”®è¯åŒ¹é…** | TF-IDF + ä½™å¼¦ç›¸ä¼¼åº¦   | 60-70% | æä½ | 1å‘¨      | âœ… V1.0  |
| **æ–¹æ¡ˆBï¼šå‘é‡æ£€ç´¢**   | Embedding + ANN       | 85-90% | é«˜   | 3å‘¨      | V1.1    |
| **æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆ**   | å…³é”®è¯åˆç­› + å‘é‡ç²¾æ’ | 80-85% | ä¸­   | 2å‘¨      | V1.2    |

**V1.0å†³ç­–ï¼šé€‰æ‹©æ–¹æ¡ˆAï¼ˆå…³é”®è¯åŒ¹é…ï¼‰**

**ç†ç”±ï¼š**

1. **éªŒè¯æ ¸å¿ƒå‡è®¾ä¼˜å…ˆ**ï¼šç”¨æˆ·æ˜¯å¦åœ¨æ„"æ€æƒ³å…±é¸£"åŠŸèƒ½æœ¬èº«ï¼ˆæ— è®ºå‡†ç¡®ç‡å¦‚ä½•ï¼‰
2. **æˆæœ¬è€ƒé‡**ï¼šèŠ‚çœ70%çš„AIæˆæœ¬ï¼ˆæ— éœ€è°ƒç”¨Embedding APIï¼‰
3. **å¼€å‘é€Ÿåº¦**ï¼š1å‘¨å³å¯ä¸Šçº¿ï¼Œå¿«é€Ÿè¿­ä»£
4. **è¶³å¤Ÿå¥½çš„ä½“éªŒ**ï¼šåœ¨èŠ‚ç‚¹æ•°<50æ—¶ï¼Œå…³é”®è¯åŒ¹é…å·²èƒ½æä¾›åˆç†çš„å…³è”ï¼ˆç”¨æˆ·å®¹å¿åº¦é«˜ï¼‰

**æ•°æ®é©±åŠ¨çš„å‡çº§å†³ç­–ï¼š**

- å¦‚æœ"æ€æƒ³å…±é¸£"åŠŸèƒ½ä½¿ç”¨ç‡ > 60% ä¸”å¥½è¯„ç‡ > 75%ï¼Œåˆ™ç«‹å³å¯åŠ¨V1.1å‘é‡æ£€ç´¢æ–¹æ¡ˆ
- å¦‚æœä½¿ç”¨ç‡ < 30%ï¼Œåˆ™æš‚ç¼“å‡çº§ï¼Œä¼˜å…ˆä¼˜åŒ–å…¶ä»–åŠŸèƒ½

---

#### **3.5.3 V1.0 ç®—æ³•é€»è¾‘ï¼ˆå…³é”®è¯åŒ¹é…ç‰ˆï¼‰**

**æ­¥éª¤1ï¼šæå–å…³é”®è¯**

```python
from sklearn.feature_extraction.text import TfidfVectorizer
import jieba.analyse

def extract_keywords(text: str, top_k: int = 10):
    """
    æå–æ–‡æœ¬å…³é”®è¯
    """
    # ä½¿ç”¨jiebaçš„TF-IDFç®—æ³•
    keywords = jieba.analyse.extract_tags(
        text,
        topK=top_k,
        withWeight=True
    )
    
    return keywords  # [(keyword, weight), ...]
```

**æ­¥éª¤2ï¼šè®¡ç®—èŠ‚ç‚¹ç›¸ä¼¼åº¦**

```python
def calculate_similarity(node_a: Node, node_b: Node):
    """
    è®¡ç®—ä¸¤ä¸ªèŠ‚ç‚¹çš„ç›¸ä¼¼åº¦
    """
    # åˆå¹¶æ ‡é¢˜å’Œå†…å®¹
    text_a = node_a.title + ' ' + node_a.content
    text_b = node_b.title + ' ' + node_b.content
    
    # æå–å…³é”®è¯
    keywords_a = extract_keywords(text_a, top_k=15)
    keywords_b = extract_keywords(text_b, top_k=15)
    
    # æ„å»ºå…³é”®è¯é›†åˆ
    set_a = set([kw[0] for kw in keywords_a])
    set_b = set([kw[0] for kw in keywords_b])
    
    # è®¡ç®—Jaccardç›¸ä¼¼åº¦
    intersection = set_a & set_b
    union = set_a | set_b
    
    if not union:
        return 0.0
    
    jaccard_sim = len(intersection) / len(union)
    
    # åŠ æƒï¼šè€ƒè™‘å…³é”®è¯æƒé‡
    weighted_sim = 0.0
    weight_sum = 0.0
    
    for kw, weight in keywords_a:
        if kw in set_b:
            weighted_sim += weight
            weight_sum += weight
    
    if weight_sum > 0:
        weighted_sim = weighted_sim / weight_sum
    
    # ç»¼åˆåˆ†æ•°
    final_score = 0.4 * jaccard_sim + 0.6 * weighted_sim
    
    return final_score
```

**æ­¥éª¤3ï¼šæŸ¥æ‰¾å…³è”èŠ‚ç‚¹**

```python
async def find_resonances(
    new_node_id: str,
    user_id: str,
    threshold: float = 0.3  # ç›¸ä¼¼åº¦é˜ˆå€¼
):
    """
    ä¸ºæ–°èŠ‚ç‚¹æŸ¥æ‰¾å…³è”
    """
    # 1. è·å–æ–°èŠ‚ç‚¹
    new_node = await db.get_node(new_node_id)
    
    # 2. è·å–ç”¨æˆ·æ‰€æœ‰å†å²èŠ‚ç‚¹ï¼ˆæ’é™¤æ–°èŠ‚ç‚¹ï¼‰
    historical_nodes = await db.get_user_nodes(
        user_id,
        exclude_id=new_node_id,
        limit=100  # æœ€å¤šæ£€ç´¢æœ€è¿‘100ä¸ªèŠ‚ç‚¹
    )
    
    if len(historical_nodes) == 0:
        return  # é¦–ä¸ªèŠ‚ç‚¹ï¼Œæ— éœ€æŸ¥æ‰¾å…³è”
    
    # 3. è®¡ç®—ç›¸ä¼¼åº¦
    similarities = []
    for old_node in historical_nodes:
        score = calculate_similarity(new_node, old_node)
        if score >= threshold:
            similarities.append((old_node, score))
    
    # 4. æ’åºå¹¶å–Top 3
    similarities.sort(key=lambda x: x[1], reverse=True)
    top_resonances = similarities[:3]
    
    # 5. ç”Ÿæˆè§£é‡Šæ–‡æœ¬
    for old_node, score in top_resonances:
        explanation = generate_simple_explanation(
            new_node, old_node, score
        )
        
        # 6. ä¿å­˜å…³è”å…³ç³»
        resonance = Resonance(
            source_node_id=new_node_id,
            related_node_id=old_node.id,
            similarity_score=score,
            ai_analysis={
                'method': 'keyword_matching',
                'explanation': explanation,
                'common_keywords': get_common_keywords(new_node, old_node)
            }
        )
        
        await db.save_resonance(resonance)
    
    # 7. é€šçŸ¥å‰ç«¯
    await notify_resonances_ready(user_id, new_node_id)
```

**æ­¥éª¤4ï¼šç”Ÿæˆç®€å•è§£é‡Š**

```python
def generate_simple_explanation(node_a: Node, node_b: Node, score: float):
    """
    ç”Ÿæˆå…³è”è§£é‡Šï¼ˆV1.0ç®€åŒ–ç‰ˆï¼Œæ— éœ€è°ƒç”¨LLMï¼‰
    """
    common_keywords = get_common_keywords(node_a, node_b)
    
    if score > 0.6:
        strength = "é«˜åº¦ç›¸å…³"
    elif score > 0.4:
        strength = "è¾ƒä¸ºç›¸å…³"
    else:
        strength = "å¯èƒ½ç›¸å…³"
    
    explanation = f"è¿™ä¸¤ä¸ªæ€æƒ³{strength}ï¼Œéƒ½æ¶‰åŠåˆ°ï¼š{', '.join(common_keywords[:3])}"
    
    return explanation

def get_common_keywords(node_a: Node, node_b: Node, top_k: int = 5):
    """
    æå–å…±åŒå…³é”®è¯
    """
    text_a = node_a.title + ' ' + node_a.content
    text_b = node_b.title + ' ' + node_b.content
    
    kw_a = set([kw[0] for kw in extract_keywords(text_a, 15)])
    kw_b = set([kw[0] for kw in extract_keywords(text_b, 15)])
    
    common = list(kw_a & kw_b)
    return common[:top_k]
```

---

#### **3.5.4 ç•Œé¢ä¸äº¤äº’**

**èŠ‚ç‚¹è¯¦æƒ…é¡µ - "æ€æƒ³å…±é¸£"æ¨¡å—:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è¿”å›]       [ğŸ“Œ æ™ºæ…§èŠ‚ç‚¹]    â”‚
â”‚                                 â”‚
â”‚  è´¹æ›¼å­¦ä¹ æ³•                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                 â”‚
â”‚  [æ ¸å¿ƒå†…å®¹åŒºåŸŸ]                 â”‚
â”‚  è´¹æ›¼å­¦ä¹ æ³•çš„æ ¸å¿ƒæ˜¯...           â”‚
â”‚                                 â”‚
â”‚  #å­¦ä¹ æ–¹æ³• #è®¤çŸ¥ç§‘å­¦             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                 â”‚
â”‚  âœ¨ æ€æƒ³å…±é¸£ (1)                â”‚  â† å¼‚æ­¥åŠ è½½
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ’¡ ä¸ã€Œé—´éš”é‡å¤åŸç†ã€ç›¸å…³    â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ è¿™ä¸¤ä¸ªæ€æƒ³é«˜åº¦ç›¸å…³ï¼Œ        â”‚ â”‚
â”‚  â”‚ éƒ½æ¶‰åŠåˆ°ï¼šè®°å¿†ã€å­¦ä¹ ã€é‡å¤  â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ ğŸ”— å…±åŒå…³é”®è¯ï¼š            â”‚ â”‚
â”‚  â”‚ #è®°å¿† #å­¦ä¹  #æ•ˆç‡          â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ [æŸ¥çœ‹å…³è”èŠ‚ç‚¹ â†’]           â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ è¿™ä¸ªå…³è”æœ‰å¸®åŠ©å—ï¼Ÿ          â”‚ â”‚
â”‚  â”‚ [ğŸ‘ æœ‰å¸®åŠ©]  [ğŸ‘ æ— å…³]     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- "æ€æƒ³å…±é¸£"æ¨¡å—ï¼šåœ†è§’å¡ç‰‡ï¼Œæµ…ç´«è‰²èƒŒæ™¯
- å¼‚æ­¥åŠ è½½ï¼šéª¨æ¶å± â†’ å†…å®¹æ¸æ˜¾
- å…³è”èŠ‚ç‚¹å¯ç‚¹å‡»è·³è½¬
- åé¦ˆæŒ‰é’®ç‚¹å‡»åæœ‰åŠ¨ç”»æ•ˆæœ
```

**åŠ è½½çŠ¶æ€:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ¨ æ€æƒ³å…±é¸£                    â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [éª¨æ¶å±åŠ¨ç”»]               â”‚ â”‚
â”‚  â”‚ â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘            â”‚ â”‚
â”‚  â”‚ â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘            â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ æ­£åœ¨å¯»æ‰¾å…±é¸£...            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç©ºçŠ¶æ€ï¼ˆæ— å…³è”ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ¨ æ€æƒ³å…±é¸£                    â”‚
â”‚                                 â”‚
â”‚  æš‚æœªå‘ç°ä¸å…¶ä»–æ€æƒ³çš„è¿æ¥        â”‚
â”‚  ç»§ç»­åˆ›å»ºèŠ‚ç‚¹ï¼Œç¼–ç»‡ä½ çš„æ™ºæ…§æ˜Ÿå›¾  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **3.5.5 æŠ€æœ¯å®ç°ç»†èŠ‚**

**åç«¯APIå®ç°:**

```python
@router.get("/api/v1/nodes/{node_id}/resonances")
async def get_node_resonances(
    node_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    è·å–èŠ‚ç‚¹çš„æ€æƒ³å…±é¸£
    """
    # 1. éªŒè¯èŠ‚ç‚¹å½’å±
    node = await db.get_node(node_id)
    if node.user_id != current_user.id:
        raise HTTPException(status_code=403, detail="æ— æƒè®¿é—®")
    
    # 2. æŸ¥è¯¢å·²ç”Ÿæˆçš„å…³è”
    resonances = await db.get_resonances(
        source_node_id=node_id,
        order_by='similarity_score DESC',
        limit=3
    )
    
    # 3. æ ¼å¼åŒ–è¿”å›
    result = []
    for res in resonances:
        related_node = await db.get_node(res.related_node_id)
        result.append({
            'resonance_id': res.id,
            'related_node': {
                'node_id': related_node.id,
                'title': related_node.title
            },
            'similarity_score': res.similarity_score,
            'analysis': {
                'explanation': res.ai_analysis['explanation'],
                'common_keywords': res.ai_analysis['common_keywords']
            },
            'created_at': res.created_at
        })
    
    return {
        'status': 'success',
        'resonances': result
    }


@router.post("/api/v1/resonances/{resonance_id}/feedback")
async def feedback_resonance(
    resonance_id: str,
    rating: str,  # 'helpful' or 'irrelevant'
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    ç”¨æˆ·åé¦ˆå…³è”è´¨é‡
    """
    resonance = await db.get_resonance(resonance_id)
    
    # æ›´æ–°åé¦ˆ
    resonance.user_feedback = rating
    await db.update(resonance)
    
    # åŸ‹ç‚¹
    analytics.track(
        user_id=current_user.id,
        event='resonance_feedback',
        properties={
            'resonance_id': resonance_id,
            'rating': rating,
            'similarity_score': resonance.similarity_score,
            'method': 'keyword_matching'
        }
    )
    
    return {'status': 'success'}
```

---

#### **3.5.6 æ€§èƒ½ä¼˜åŒ–**

| ä¼˜åŒ–ç‚¹       | å®ç°æ–¹å¼                     | æ•ˆæœ         |
| ------------ | ---------------------------- | ------------ |
| **å¼‚æ­¥å¤„ç†** | èŠ‚ç‚¹åˆ›å»ºåï¼Œå¼‚æ­¥ä»»åŠ¡è®¡ç®—å…³è” | ä¸é˜»å¡ä¸»æµç¨‹ |
| **æ‰¹é‡è®¡ç®—** | ä½¿ç”¨numpy/scipyå‘é‡åŒ–è®¡ç®—    | æ€§èƒ½æå‡10x  |
| **ç¼“å­˜ç­–ç•¥** | ç¼“å­˜æ¯ä¸ªèŠ‚ç‚¹çš„å…³é”®è¯å‘é‡     | å‡å°‘é‡å¤è®¡ç®— |
| **é™åˆ¶èŒƒå›´** | åªæ£€ç´¢æœ€è¿‘100ä¸ªå†å²èŠ‚ç‚¹      | æ§åˆ¶è®¡ç®—é‡   |
| **é™çº§ç­–ç•¥** | è¶…è¿‡3ç§’æœªå®Œæˆåˆ™æš‚ä¸å±•ç¤º      | ä¿è¯ä½“éªŒ     |

---

#### **3.5.7 æ•°æ®åŸ‹ç‚¹**

| äº‹ä»¶åç§°                         | è§¦å‘æ—¶æœº             | å…³é”®å‚æ•°                                             |
| -------------------------------- | -------------------- | ---------------------------------------------------- |
| `resonance_calculation_start`    | å¼€å§‹è®¡ç®—å…³è”         | `node_id`, `history_nodes_count`                     |
| `resonance_calculation_complete` | è®¡ç®—å®Œæˆ             | `duration`, `resonances_found`                       |
| `resonance_shown`                | å‰ç«¯å±•ç¤ºå…³è”         | `node_id`, `resonance_id`, `similarity_score`        |
| `resonance_clicked`              | ç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹å…³è”èŠ‚ç‚¹ | `source_node_id`, `related_node_id`                  |
| `resonance_feedback`             | ç”¨æˆ·åé¦ˆ             | `rating: 'helpful'/'irrelevant'`, `similarity_score` |

---

#### **3.5.8 éªŒæ”¶æ ‡å‡†**

**åŠŸèƒ½éªŒæ”¶ï¼š**

- [ ] æ–°èŠ‚ç‚¹åˆ›å»ºå10ç§’å†…å®Œæˆå…³è”è®¡ç®—
- [ ] å…³è”å‘ç°ç‡ â‰¥ 40%ï¼ˆæœ‰èŠ‚ç‚¹æ•°â‰¥3çš„ç”¨æˆ·ï¼‰
- [ ] å…³è”å‡†ç¡®ç‡ â‰¥ 60%ï¼ˆç”¨æˆ·åé¦ˆ"æœ‰å¸®åŠ©"çš„æ¯”ä¾‹ï¼‰
- [ ] å¼‚æ­¥åŠ è½½æµç•…ï¼Œæ— é˜»å¡

**ä½“éªŒéªŒæ”¶ï¼š**

- [ ] "æ€æƒ³å…±é¸£"æ¨¡å—æœ‰æ˜ç¡®çš„ç©ºçŠ¶æ€å’ŒåŠ è½½çŠ¶æ€
- [ ] å…³è”è§£é‡Šæ–‡æ¡ˆæ˜“æ‡‚
- [ ] å¯ç‚¹å‡»è·³è½¬è‡³å…³è”èŠ‚ç‚¹

**æ•°æ®éªŒæ”¶ï¼š**

- [ ] "æ€æƒ³å…±é¸£"åŠŸèƒ½ä½¿ç”¨ç‡ â‰¥ 50%
- [ ] å¥½è¯„ç‡ï¼ˆğŸ‘ï¼‰ â‰¥ 75%
- [ ] æŸ¥çœ‹å…³è”èŠ‚ç‚¹çš„ç‚¹å‡»ç‡ â‰¥ 30%

**å‡çº§å†³ç­–ï¼š**

- âœ… å¦‚æœå¥½è¯„ç‡ â‰¥ 80% ä¸”ä½¿ç”¨ç‡ â‰¥ 60%ï¼Œç«‹å³å¯åŠ¨V1.1å‘é‡æ£€ç´¢ç‰ˆ
- âŒ å¦‚æœä½¿ç”¨ç‡ < 30%ï¼Œæš‚ç¼“å‡çº§ï¼Œä¼˜å…ˆä¼˜åŒ–è§£é‡Šæ–‡æ¡ˆå’Œäº¤äº’

---

ç°åœ¨ç»§ç»­ç”ŸæˆUS6ï¼ˆè®°å¿†å¤ä¹ ï¼‰...

---

### **3.6 US6: è®°å¿†å”¤é†’ - åœ¨é—å¿˜è¾¹ç•Œçš„æ¸©æŸ”æé†’**

#### **3.6.1 åŠŸèƒ½ç›®æ ‡**

- åŸºäºç§‘å­¦çš„é—´éš”é‡å¤ç®—æ³•ï¼Œæ„å»ºä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’
- é€šè¿‡ä¸»åŠ¨æ¨é€ï¼Œé™ä½ç”¨æˆ·å¤ä¹ çš„å¿ƒç†é—¨æ§›
- éªŒè¯æ ¸å¿ƒå‡è®¾H3ï¼š**ç”¨æˆ·æ˜¯å¦ä¼šéµå¾ªAIæ¨é€çš„å¤ä¹ è®¡åˆ’å¹¶å½¢æˆä¹ æƒ¯**

**è¿™æ˜¯V1.0 MVPæœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œç›´æ¥å†³å®š30æ—¥ç•™å­˜ç‡ã€‚**

---

#### **3.6.2 è®°å¿†ç®—æ³•é€‰æ‹©ï¼šSM-2ç®—æ³•**

**ä¸ºä½•é€‰æ‹©SM-2ï¼š**

1. âœ… **ç®—æ³•æˆç†Ÿ**ï¼šè‡ª1988å¹´ä»¥æ¥ç»è¿‡å¤§é‡éªŒè¯
2. âœ… **å®ç°ç®€å•**ï¼šæ— éœ€æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œçº¯æ•°å­¦å…¬å¼
3. âœ… **æ•ˆæœå¯é¢„æµ‹**ï¼šå‚æ•°æ˜ç¡®ï¼Œæ˜“äºè°ƒè¯•
4. âœ… **ä¸ªæ€§åŒ–**ï¼šæ ¹æ®ç”¨æˆ·åé¦ˆåŠ¨æ€è°ƒæ•´éš¾åº¦ç³»æ•°

**SM-2æ ¸å¿ƒå‚æ•°ï¼š**

| å‚æ•°   | å«ä¹‰                        | åˆå§‹å€¼ | å–å€¼èŒƒå›´   |
| ------ | --------------------------- | ------ | ---------- |
| `n`    | å¤ä¹ æ¬¡æ•°                    | 0      | [0, +âˆ)    |
| `EF`   | ç®€å•ç³»æ•°ï¼ˆEasiness Factorï¼‰ | 2.5    | [1.3, 2.5] |
| `I(n)` | ç¬¬næ¬¡å¤ä¹ çš„é—´éš”å¤©æ•°         | -      | [1, +âˆ)    |
| `q`    | ç”¨æˆ·è¯„åˆ†ï¼ˆè´¨é‡ï¼‰            | -      | [0, 5]     |

**æˆ‘ä»¬å°†5æ¡£è¯„åˆ†ç®€åŒ–ä¸º3æ¡£ï¼š**

| ç”¨æˆ·é€‰æ‹©   | å†…éƒ¨è¯„åˆ†q | å«ä¹‰           |
| ---------- | --------- | -------------- |
| **å¿˜è®°äº†** | 2         | å®Œå…¨ä¸è®°å¾—     |
| **æ¨¡ç³Š**   | 3         | æœ‰å°è±¡ä½†ä¸æ¸…æ™° |
| **æŒæ¡äº†** | 5         | å®Œå…¨è®°ä½       |

---

#### **3.6.3 ç®—æ³•å®ç°**

```python
class SM2MemoryScheduler:
    """
    SM-2é—´éš”é‡å¤ç®—æ³•å®ç°
    """
    
    @staticmethod
    def init_memory_stats():
        """
        åˆå§‹åŒ–è®°å¿†å‚æ•°
        """
        return {
            'repetition_count': 0,
            'easiness_factor': 2.5,
            'interval_days': 0,
            'next_review_date': datetime.now().date()
        }
    
    @staticmethod
    def calculate_next_review(
        quality_score: int,  # 2, 3, æˆ– 5
        current_stats: dict
    ) -> dict:
        """
        æ ¹æ®ç”¨æˆ·è¯„åˆ†è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
        """
        n = current_stats['repetition_count']
        EF = current_stats['easiness_factor']
        q = quality_score
        
        # 1. æ›´æ–°EFï¼ˆç®€å•ç³»æ•°ï¼‰
        EF_new = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
        EF_new = max(1.3, EF_new)  # EFä¸ä½äº1.3
        
        # 2. è®¡ç®—æ–°çš„é—´éš”
        if q < 3:
            # å›ç­”é”™è¯¯ï¼Œé‡æ–°å¼€å§‹
            n_new = 0
            I_new = 1  # æ˜å¤©å†å¤ä¹ 
        else:
            # å›ç­”æ­£ç¡®
            n_new = n + 1
            if n_new == 1:
                I_new = 1  # ç¬¬ä¸€æ¬¡ï¼š1å¤©å
            elif n_new == 2:
                I_new = 6  # ç¬¬äºŒæ¬¡ï¼š6å¤©å
            else:
                I_prev = current_stats['interval_days']
                I_new = round(I_prev * EF_new)  # ä¹‹åï¼šé—´éš”*EF
        
        # 3. è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        next_date = datetime.now().date() + timedelta(days=I_new)
        
        return {
            'repetition_count': n_new,
            'easiness_factor': EF_new,
            'interval_days': I_new,
            'next_review_date': next_date
        }
    
    @staticmethod
    def get_due_nodes(user_id: str, db: Session):
        """
        è·å–ä»Šæ—¥åº”å¤ä¹ çš„èŠ‚ç‚¹
        """
        today = datetime.now().date()
        
        # æŸ¥è¯¢next_review_date <= todayçš„èŠ‚ç‚¹
        due_nodes = db.query(Node).filter(
            Node.user_id == user_id,
            Node.memory_stats['next_review_date'].astext.cast(Date) <= today
        ).order_by(
            # ä¼˜å…ˆå¤ä¹ è¿‡æœŸæœ€ä¹…çš„
            Node.memory_stats['next_review_date'].astext
        ).limit(20).all()  # æ¯å¤©æœ€å¤š20ä¸ª
        
        return due_nodes
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
# ç”¨æˆ·å®Œæˆä¸€æ¬¡å¤ä¹ 
def handle_review_result(node_id: str, quality_score: int):
    node = db.get_node(node_id)
    
    # è®¡ç®—æ–°çš„è®°å¿†å‚æ•°
    new_stats = SM2MemoryScheduler.calculate_next_review(
        quality_score=quality_score,
        current_stats=node.memory_stats
    )
    
    # æ›´æ–°èŠ‚ç‚¹
    node.memory_stats = new_stats
    node.last_reviewed_at = datetime.now()
    db.commit()
    
    return new_stats['interval_days']  # è¿”å›ä¸‹æ¬¡å¤ä¹ é—´éš”ï¼ˆå¤©ï¼‰
```

---

#### **3.6.4 é€»è¾‘æµç¨‹**

**æ¯æ—¥å¤ä¹ æ¨é€æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant Cron as å®šæ—¶ä»»åŠ¡
    participant DB as æ•°æ®åº“
    participant WX as å¾®ä¿¡è®¢é˜…æ¶ˆæ¯
    participant U as ç”¨æˆ·

    Cron->>DB: æ¯æ—¥08:00æ‰§è¡Œ
    DB->>DB: æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„å¾…å¤ä¹ èŠ‚ç‚¹
    
    loop æ¯ä¸ªæœ‰å¾…å¤ä¹ çš„ç”¨æˆ·
        DB->>WX: å‘é€è®¢é˜…æ¶ˆæ¯
        WX->>U: æ¨é€é€šçŸ¥
    end
    
    U->>å°ç¨‹åº: ç‚¹å‡»é€šçŸ¥/ä¸»åŠ¨æ‰“å¼€
    å°ç¨‹åº->>DB: GET /awakening/queue
    DB-->>å°ç¨‹åº: è¿”å›å¾…å¤ä¹ èŠ‚ç‚¹åˆ—è¡¨
    
    loop æ¯ä¸ªèŠ‚ç‚¹
        å°ç¨‹åº->>U: å±•ç¤ºé—ªå¡ï¼ˆæ ‡é¢˜ï¼‰
        U->>å°ç¨‹åº: ç‚¹å‡»"æŸ¥çœ‹ç­”æ¡ˆ"
        å°ç¨‹åº->>U: å±•ç¤ºå†…å®¹
        U->>å°ç¨‹åº: é€‰æ‹©ï¼šå¿˜è®°äº†/æ¨¡ç³Š/æŒæ¡äº†
        å°ç¨‹åº->>DB: POST /awakening/review
        DB->>DB: æ›´æ–°è®°å¿†å‚æ•°
        DB-->>å°ç¨‹åº: è¿”å›ä¸‹æ¬¡å¤ä¹ æ—¶é—´
        å°ç¨‹åº->>U: æç¤º"å°†åœ¨Xå¤©åå†æ¬¡å¤ä¹ "
    end
    
    å°ç¨‹åº->>U: å±•ç¤ºå®Œæˆé¡µé¢
```

---

#### **3.6.5 ç•Œé¢ä¸äº¤äº’**

**ä¸»ç•Œé¢ - å¤ä¹ å…¥å£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< ç»‡å¿µ]         [ğŸ””3]  â† çº¢ç‚¹æç¤ºâ”‚
â”‚                                 â”‚
â”‚  ä»Šæ—¥å¾…å”¤é†’ (3)                  â”‚  â† é¡¶éƒ¨æ¨ªå¹…
â”‚  å¤ä¹ å¯ä»¥å·©å›ºè®°å¿†å“¦ â†’            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                 â”‚
â”‚  [æ™ºæ…§èŠ‚ç‚¹åˆ—è¡¨]                 â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- æ¨ªå¹…èƒŒæ™¯ï¼šæ¸å˜ç´«è‰²
- ç‚¹å‡»æ¨ªå¹…è¿›å…¥å¤ä¹ é¡µé¢
- å³ä¸Šè§’æ¶ˆæ¯å›¾æ ‡æ˜¾ç¤ºå¾…å¤ä¹ æ•°é‡ï¼ˆçº¢ç‚¹ï¼‰
```

**é—ªå¡æ¨¡å¼ - æ­£é¢ï¼ˆé—®é¢˜ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [âœ•]            å¤ä¹  2/5         â”‚  â† å¯é€€å‡ºï¼Œæ˜¾ç¤ºè¿›åº¦
â”‚                                 â”‚
â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚  é—ªå¡åŒºåŸŸ    â”‚         â”‚
â”‚         â”‚             â”‚         â”‚
â”‚         â”‚  è´¹æ›¼å­¦ä¹ æ³•  â”‚  â† èŠ‚ç‚¹æ ‡é¢˜
â”‚         â”‚             â”‚         â”‚
â”‚         â”‚             â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚      [ğŸ’¡ æŸ¥çœ‹ç­”æ¡ˆ]              â”‚  â† CTAæŒ‰é’®
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- é—ªå¡ï¼šç™½è‰²å¡ç‰‡ï¼Œåœ†è§’24pxï¼Œé˜´å½±
- å¡ç‰‡ä¸­å¤®æ˜¾ç¤ºèŠ‚ç‚¹æ ‡é¢˜
- æ”¯æŒå·¦å³æ»‘åŠ¨åˆ‡æ¢ï¼ˆå¯é€‰ï¼‰
```

**é—ªå¡æ¨¡å¼ - åé¢ï¼ˆç­”æ¡ˆï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [âœ•]            å¤ä¹  2/5         â”‚
â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚  é—ªå¡åŒºåŸŸ    â”‚         â”‚
â”‚         â”‚             â”‚         â”‚
â”‚         â”‚ è´¹æ›¼å­¦ä¹ æ³•   â”‚  â† æ ‡é¢˜
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚         â”‚
â”‚         â”‚ [æ ¸å¿ƒå†…å®¹]   â”‚  â† å†…å®¹æ‘˜è¦
â”‚         â”‚ è´¹æ›¼å­¦ä¹ æ³•çš„ â”‚    ï¼ˆå¯æ»šåŠ¨ï¼‰
â”‚         â”‚ æ ¸å¿ƒæ˜¯...    â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                 â”‚
â”‚    ä½ æŒæ¡äº†è¿™ä¸ªçŸ¥è¯†å—ï¼Ÿ          â”‚
â”‚                                 â”‚
â”‚  [ğŸ˜• å¿˜è®°äº†] [ğŸ˜ æ¨¡ç³Š] [ğŸ˜Š æŒæ¡äº†]â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- ç‚¹å‡»"æŸ¥çœ‹ç­”æ¡ˆ"åç¿»è½¬åŠ¨ç”»ï¼ˆ3Dæ•ˆæœï¼‰
- ä¸‰ä¸ªé€‰é¡¹æŒ‰é’®æ°´å¹³æ’åˆ—
- ç‚¹å‡»åçŸ­æš‚æ˜¾ç¤ºåé¦ˆï¼Œç„¶åè¿›å…¥ä¸‹ä¸€å¼ 
```

**å•å¼ åé¦ˆæç¤º:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚         [âœ“ å·²è®°å½•]              â”‚
â”‚                                 â”‚
â”‚      å°†åœ¨ 6 å¤©åå†æ¬¡å¤ä¹          â”‚
â”‚                                 â”‚
â”‚      [è‡ªåŠ¨è·³è½¬ä¸‹ä¸€å¼ ... 2s]      â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡è§„èŒƒï¼š
- åŠé€æ˜é®ç½©
- ç»¿è‰²âˆšå›¾æ ‡ï¼ˆæŒæ¡äº†ï¼‰
- æ©™è‰²âš ï¸å›¾æ ‡ï¼ˆæ¨¡ç³Šï¼‰
- çº¢è‰²âœ•å›¾æ ‡ï¼ˆå¿˜è®°äº†ï¼‰
- 2ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å¼ 
```

**å®Œæˆé¡µé¢:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚         âœ¨                      â”‚
â”‚                                 â”‚
â”‚     å¤ªæ£’äº†ï¼                     â”‚
â”‚     ä»Šæ—¥çš„è®°å¿†å·²è¢«ç‚¹äº®            â”‚
â”‚                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ ä»Šæ—¥å¤ä¹ ï¼š5ä¸ª      â”‚       â”‚
â”‚     â”‚ æŒæ¡ï¼š3ä¸ª         â”‚       â”‚
â”‚     â”‚ æ¨¡ç³Šï¼š2ä¸ª         â”‚       â”‚
â”‚     â”‚ å¿˜è®°ï¼š0ä¸ª         â”‚       â”‚
â”‚     â”‚                   â”‚       â”‚
â”‚     â”‚ è¿ç»­å¤ä¹ ï¼š7å¤© ğŸ”¥  â”‚  â† Streak
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â”‚
â”‚   [ç»§ç»­åˆ›å»ºæ–°èŠ‚ç‚¹]  [å®Œæˆ]       â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¿€åŠ±æœºåˆ¶ï¼š
- æ˜¾ç¤ºè¿ç»­å¤ä¹ å¤©æ•°ï¼ˆStreakï¼‰
- å±•ç¤ºä»Šæ—¥ç»Ÿè®¡
- ç§¯æçš„æƒ…æ„ŸåŒ–æ–‡æ¡ˆ
```

**ç©ºçŠ¶æ€ï¼ˆæ— å¾…å¤ä¹ ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è¿”å›]        è®°å¿†å”¤é†’        â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚         ğŸ˜Œ                      â”‚
â”‚                                 â”‚
â”‚     ä»Šæ—¥æ— éœ€å¤ä¹                  â”‚
â”‚     ä½ çš„è®°å¿†çŠ¶æ€å¾ˆå¥½ï¼            â”‚
â”‚                                 â”‚
â”‚     å»åˆ›å»ºæ–°çš„æ€æƒ³èŠ‚ç‚¹å§          â”‚
â”‚                                 â”‚
â”‚     [è¿”å›é¦–é¡µ]                   â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **3.6.6 å¾®ä¿¡è®¢é˜…æ¶ˆæ¯æ¨é€**

**æ¶ˆæ¯æ¨¡æ¿è®¾è®¡ï¼š**

```
æ ‡é¢˜ï¼šğŸ’¡ æ™ºæ…§è€³è¯­

thing1ï¼ˆæé†’å†…å®¹ï¼‰ï¼šä½ æœ‰3ä¸ªæ€æƒ³å³å°†é—å¿˜
thing2ï¼ˆçŸ¥è¯†ç¤ºä¾‹ï¼‰ï¼šè´¹æ›¼å­¦ä¹ æ³•ã€é—´éš”é‡å¤åŸç†...
time3ï¼ˆæé†’æ—¶é—´ï¼‰ï¼š2025-10-21 08:00

ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’
```

**æ¨é€ç­–ç•¥ï¼š**

| åœºæ™¯         | æ¨é€æ—¶é—´         | æ¨é€æ¡ä»¶          | é¢‘ç‡é™åˆ¶ |
| ------------ | ---------------- | ----------------- | -------- |
| **æ—¥å¸¸å¤ä¹ ** | æ¯æ—¥08:00        | æœ‰å¾…å¤ä¹ èŠ‚ç‚¹      | æ¯å¤©1æ¬¡  |
| **é¦–æ¬¡å¤ä¹ ** | èŠ‚ç‚¹åˆ›å»ºå24å°æ—¶ | æ–°èŠ‚ç‚¹é¦–æ¬¡å¤ä¹     | -        |
| **é‡è¦å¤ä¹ ** | è‡ªå®šä¹‰æ—¶é—´       | è¶…è¿‡3ä¸ªå¾…å¤ä¹ èŠ‚ç‚¹ | æ¯å¤©1æ¬¡  |

**æ¨é€ä¼˜åŒ–ï¼š**

- âœ… ç”¨æˆ·å¯è‡ªå®šä¹‰æ¨é€æ—¶é—´ï¼ˆè®¾ç½®é¡µï¼‰
- âœ… ç”¨æˆ·å¯å…³é—­æ¨é€ï¼ˆä½†ä¼šå½±å“ç•™å­˜ï¼Œéœ€å¼•å¯¼ï¼‰
- âœ… è¿ç»­3å¤©æœªå¤ä¹ ï¼Œé™ä½æ¨é€é¢‘ç‡
- âœ… æ¨é€æ–‡æ¡ˆè½®æ¢ï¼Œé¿å…ç–²åŠ³

---

#### **3.6.7 æŠ€æœ¯å®ç°**

**å®šæ—¶ä»»åŠ¡ï¼ˆCelery Beatï¼‰:**

```python
from celery import Celery
from celery.schedules import crontab

app = Celery('weave')

@app.task
def daily_review_reminder():
    """
    æ¯æ—¥å¤ä¹ æé†’ä»»åŠ¡
    """
    today = datetime.now().date()
    
    # 1. æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    users = db.query(User).filter(
        User.subscribe_msg_enabled == True
    ).all()
    
    for user in users:
        # 2. è·å–å¾…å¤ä¹ èŠ‚ç‚¹
        due_nodes = SM2MemoryScheduler.get_due_nodes(user.id, db)
        
        if len(due_nodes) == 0:
            continue  # æ— å¾…å¤ä¹ ï¼Œè·³è¿‡
        
        # 3. æ„å»ºæ¶ˆæ¯å†…å®¹
        node_titles = [n.title for n in due_nodes[:3]]
        
        # 4. å‘é€è®¢é˜…æ¶ˆæ¯
        try:
            send_subscribe_message(
                openid=user.wx_openid,
                template_id=TEMPLATE_ID,
                data={
                    'thing1': f'ä½ æœ‰{len(due_nodes)}ä¸ªæ€æƒ³å³å°†é—å¿˜',
                    'thing2': 'ã€'.join(node_titles),
                    'time3': datetime.now().strftime('%Y-%m-%d %H:%M')
                },
                page='/pages/awakening/index'
            )
            
            # 5. è®°å½•æ¨é€
            analytics.track(
                user_id=user.id,
                event='review_reminder_sent',
                properties={
                    'due_nodes_count': len(due_nodes),
                    'push_time': datetime.now()
                }
            )
            
        except Exception as e:
            logger.error(f"Failed to send reminder to {user.id}: {e}")

# é…ç½®å®šæ—¶ä»»åŠ¡
app.conf.beat_schedule = {
    'daily-review-reminder': {
        'task': 'daily_review_reminder',
        'schedule': crontab(hour=8, minute=0),  # æ¯å¤©08:00
    },
}
```

**APIå®ç°:**

```python
@router.get("/api/v1/awakening/queue")
async def get_review_queue(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    è·å–ä»Šæ—¥å¾…å¤ä¹ é˜Ÿåˆ—
    """
    due_nodes = SM2MemoryScheduler.get_due_nodes(current_user.id, db)
    
    # æ ¼å¼åŒ–è¿”å›
    queue = []
    for node in due_nodes:
        queue.append({
            'node_id': node.id,
            'title': node.title,
            'content': node.content[:200],  # å‰200å­—
            'tags': node.tags,
            'last_reviewed_at': node.last_reviewed_at,
            'repetition_count': node.memory_stats['repetition_count']
        })
    
    # åŸ‹ç‚¹
    analytics.track(
        user_id=current_user.id,
        event='review_queue_fetched',
        properties={
            'queue_size': len(queue)
        }
    )
    
    return {
        'status': 'success',
        'queue': queue,
        'total': len(queue)
    }


@router.post("/api/v1/awakening/review")
async def submit_review_result(
    node_id: str,
    quality_score: int,  # 2, 3, 5
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    æäº¤å¤ä¹ ç»“æœ
    """
    # 1. éªŒè¯å‚æ•°
    if quality_score not in [2, 3, 5]:
        raise HTTPException(status_code=400, detail="Invalid quality_score")
    
    # 2. è·å–èŠ‚ç‚¹
    node = await db.get_node(node_id)
    if node.user_id != current_user.id:
        raise HTTPException(status_code=403, detail="Unauthorized")
    
    # 3. è®¡ç®—æ–°çš„è®°å¿†å‚æ•°
    new_stats = SM2MemoryScheduler.calculate_next_review(
        quality_score=quality_score,
        current_stats=node.memory_stats
    )
    
    # 4. æ›´æ–°èŠ‚ç‚¹
    node.memory_stats = new_stats
    node.last_reviewed_at = datetime.now()
    await db.update(node)
    
    # 5. è®°å½•å¤ä¹ å†å²
    review_log = ReviewLog(
        user_id=current_user.id,
        node_id=node_id,
        quality_score=quality_score,
        interval_days=new_stats['interval_days'],
        reviewed_at=datetime.now()
    )
    await db.save(review_log)
    
    # 6. åŸ‹ç‚¹
    analytics.track(
        user_id=current_user.id,
        event='node_reviewed',
        properties={
            'node_id': node_id,
            'quality_score': quality_score,
            'next_interval_days': new_stats['interval_days'],
            'repetition_count': new_stats['repetition_count']
        }
    )
    
    # 7. æ£€æŸ¥æ˜¯å¦"å”¤é†’"ï¼ˆç”¨äºè®¡ç®—åŒ—ææ˜ŸæŒ‡æ ‡W.A.N.U.ï¼‰
    if quality_score == 5:  # æŒæ¡äº†
        analytics.track(
            user_id=current_user.id,
            event='node_awakened',  # å…³é”®äº‹ä»¶ï¼
            properties={
                'node_id': node_id
            }
        )
    
    return {
        'status': 'success',
        'next_review_in_days': new_stats['interval_days'],
        'message': f"å°†åœ¨ {new_stats['interval_days']} å¤©åå†æ¬¡å¤ä¹ "
    }
```

---

#### **3.6.8 æ•°æ®åŸ‹ç‚¹**

| äº‹ä»¶åç§°                   | è§¦å‘æ—¶æœº         | å…³é”®å‚æ•°                                         |
| -------------------------- | ---------------- | ------------------------------------------------ |
| `review_reminder_sent`     | å‘é€è®¢é˜…æ¶ˆæ¯     | `due_nodes_count`, `push_time`                   |
| `review_reminder_clicked`  | ç”¨æˆ·ç‚¹å‡»æ¨é€æ¶ˆæ¯ | `source: 'push'`                                 |
| `review_queue_fetched`     | è·å–å¤ä¹ é˜Ÿåˆ—     | `queue_size`                                     |
| `review_session_start`     | å¼€å§‹å¤ä¹          | `total_nodes`                                    |
| `flashcard_view`           | æŸ¥çœ‹é—ªå¡æ­£é¢     | `node_id`                                        |
| `flashcard_reveal`         | ç‚¹å‡»"æŸ¥çœ‹ç­”æ¡ˆ"   | `node_id`, `view_duration`                       |
| `node_reviewed`            | æäº¤è¯„åˆ†         | `node_id`, `quality_score`, `next_interval_days` |
| `node_awakened`            | è¯„åˆ†ä¸º"æŒæ¡äº†"   | `node_id` â† **åŒ—ææ˜ŸæŒ‡æ ‡**                       |
| `review_session_complete`  | å®Œæˆæ‰€æœ‰å¤ä¹      | `total_nodes`, `mastered_count`, `duration`      |
| `review_session_abandoned` | ä¸­é€”é€€å‡º         | `completed_count`, `total_nodes`                 |
| `review_streak_updated`    | è¿ç»­å¤ä¹ å¤©æ•°æ›´æ–° | `streak_days`                                    |

---

#### **3.6.9 éªŒæ”¶æ ‡å‡†**

**åŠŸèƒ½éªŒæ”¶ï¼š**

- [ ] SM-2ç®—æ³•æ­£ç¡®å®ç°ï¼ˆå•å…ƒæµ‹è¯•è¦†ç›–ç‡100%ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡å‡†æ—¶æ‰§è¡Œï¼ˆè¯¯å·®<5åˆ†é’Ÿï¼‰
- [ ] è®¢é˜…æ¶ˆæ¯æˆåŠŸæ¨é€ï¼ˆæˆåŠŸç‡>95%ï¼‰
- [ ] é—ªå¡ç¿»è½¬åŠ¨ç”»æµç•…ï¼ˆ60fpsï¼‰
- [ ] å¤ä¹ ç»“æœæ­£ç¡®ä¿å­˜å¹¶æ›´æ–°å‚æ•°

**ä½“éªŒéªŒæ”¶ï¼š**

- [ ] å¤ä¹ æµç¨‹ç®€æ´ï¼Œå•ä¸ªèŠ‚ç‚¹<10ç§’
- [ ] å®Œæˆé¡µæœ‰æˆå°±æ„Ÿ
- [ ] ç©ºçŠ¶æ€æœ‰æ˜ç¡®å¼•å¯¼
- [ ] ä¸­é€”é€€å‡ºå¯æ¢å¤è¿›åº¦

**æ ¸å¿ƒKPIéªŒæ”¶ï¼š**

- [ ] **å¤ä¹ ä¼šè¯å®Œæˆç‡ â‰¥ 30%**
- [ ] **W.A.N.U.ï¼ˆå‘¨åº¦èŠ‚ç‚¹å”¤é†’ç”¨æˆ·æ•°ï¼‰ â‰¥ 100**
- [ ] **30æ—¥ç•™å­˜ç‡ â‰¥ 8%**
- [ ] è®¢é˜…æ¶ˆæ¯å…³é—­ç‡ â‰¤ 20%

---

ç°åœ¨ç»§ç»­US7å’ŒUS8...

---

### **3.7 US7: èŠ‚ç‚¹ç¼–è¾‘ä¸åˆ é™¤ - æŒæ§ä½ çš„æ€æƒ³**

#### **3.7.1 åŠŸèƒ½ç›®æ ‡**

- èµ‹äºˆç”¨æˆ·å¯¹AIç”Ÿæˆå†…å®¹çš„å®Œå…¨æŒæ§æƒ
- å¤„ç†AIç†è§£é”™è¯¯æˆ–ç”¨æˆ·éœ€æ±‚å˜åŒ–çš„åœºæ™¯
- å»ºç«‹ç”¨æˆ·å¯¹äº§å“çš„ä¿¡ä»»æ„Ÿ

**è®¾è®¡åŸåˆ™ï¼š**

- âœ… **äºŒæ¬¡ç¡®è®¤**ï¼šåˆ é™¤éœ€è¦ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œ
- âœ… **å¯æ¢å¤**ï¼šåˆ é™¤å30å¤©å†…å¯æ¢å¤ï¼ˆè½¯åˆ é™¤ï¼‰
- âœ… **ä¿ç•™å†å²**ï¼šç¼–è¾‘ä¿ç•™ç‰ˆæœ¬å†å²ï¼ˆå¯é€‰æŸ¥çœ‹ï¼‰

---

#### **3.7.2 åŠŸèƒ½è§„æ ¼**

**ç¼–è¾‘åŠŸèƒ½ï¼š**

| å¯ç¼–è¾‘é¡¹     | é™åˆ¶               | è¯´æ˜               |
| ------------ | ------------------ | ------------------ |
| **æ ‡é¢˜**     | 1-100å­—ç¬¦          | å¿…å¡«               |
| **å†…å®¹**     | 10-5000å­—ç¬¦        | å¿…å¡«ï¼Œæ”¯æŒMarkdown |
| **æ ‡ç­¾**     | 0-5ä¸ªï¼Œæ¯ä¸ªâ‰¤10å­—ç¬¦ | é€‰å¡«               |
| **åŸå§‹è¾“å…¥** | ä¸å¯ç¼–è¾‘           | ä¿æŒå¯è¿½æº¯æ€§       |
| **è®°å¿†å‚æ•°** | ä¸å¯ç¼–è¾‘           | ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†       |

**åˆ é™¤åŠŸèƒ½ï¼š**

| åˆ é™¤ç±»å‹   | è¡Œä¸º                  | æ¢å¤æœŸé™     |
| ---------- | --------------------- | ------------ |
| **è½¯åˆ é™¤** | æ ‡è®°ä¸ºdeletedï¼Œä¸å±•ç¤º | 30å¤©å†…å¯æ¢å¤ |
| **ç¡¬åˆ é™¤** | å®Œå…¨åˆ é™¤ï¼ˆä»…ç®¡ç†å‘˜ï¼‰  | ä¸å¯æ¢å¤     |

---

#### **3.7.3 ç•Œé¢ä¸äº¤äº’**

**èŠ‚ç‚¹è¯¦æƒ…é¡µ - æ“ä½œå…¥å£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è¿”å›]       [â‹¯ æ›´å¤š]        â”‚  â† ç‚¹å‡»å±•å¼€èœå•
â”‚                                 â”‚
â”‚  è´¹æ›¼å­¦ä¹ æ³•                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                 â”‚
â”‚  [èŠ‚ç‚¹å†…å®¹]                     â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡»[â‹¯ æ›´å¤š]å±•å¼€æ“ä½œèœå•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸ ç¼–è¾‘èŠ‚ç‚¹                    â”‚
â”‚  ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹                    â”‚
â”‚  ğŸ“¤ åˆ†äº«èŠ‚ç‚¹ï¼ˆV1.1ï¼‰             â”‚
â”‚  âœ• å–æ¶ˆ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¼–è¾‘é¡µé¢:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [âœ• å–æ¶ˆ]       ç¼–è¾‘èŠ‚ç‚¹  [âœ“ ä¿å­˜]â”‚
â”‚                                 â”‚
â”‚  æ ‡é¢˜                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è´¹æ›¼å­¦ä¹ æ³•                 â”‚ â”‚  â† å¯ç¼–è¾‘è¾“å…¥æ¡†
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  å†…å®¹ (æ”¯æŒMarkdown)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è´¹æ›¼å­¦ä¹ æ³•çš„æ ¸å¿ƒæ˜¯...       â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚  â† å¤šè¡Œæ–‡æœ¬æ¡†
â”‚  â”‚                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  æ ‡ç­¾                           â”‚
â”‚  [#å­¦ä¹ æ–¹æ³•] [#è®¤çŸ¥ç§‘å­¦] [+æ·»åŠ ] â”‚
â”‚                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ æç¤ºï¼š                      â”‚
â”‚  ä¿®æ”¹åä¼šä¿ç•™ç¼–è¾‘å†å²ï¼Œ          â”‚
â”‚  ä½ å¯ä»¥éšæ—¶æŸ¥çœ‹åŸå§‹ç‰ˆæœ¬          â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’è§„èŒƒï¼š
- å®æ—¶ä¿å­˜è‰ç¨¿ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
- ç‚¹å‡»"ä¿å­˜"åæ˜¾ç¤ºToastï¼š"å·²ä¿å­˜"
- å¦‚æœ‰æœªä¿å­˜å†…å®¹ï¼Œé€€å‡ºæ—¶äºŒæ¬¡ç¡®è®¤
```

**åˆ é™¤ç¡®è®¤å¼¹çª—:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚  âš ï¸ ç¡®è®¤åˆ é™¤ï¼Ÿ                  â”‚
â”‚                                 â”‚
â”‚  ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ€æƒ³èŠ‚ç‚¹å—ï¼Ÿ     â”‚
â”‚                                 â”‚
â”‚  ã€Œè´¹æ›¼å­¦ä¹ æ³•ã€                  â”‚
â”‚                                 â”‚
â”‚  åˆ é™¤å30å¤©å†…å¯ä»¥æ¢å¤            â”‚
â”‚                                 â”‚
â”‚  [å–æ¶ˆ]          [ç¡®è®¤åˆ é™¤]      â”‚
â”‚                   (çº¢è‰²æŒ‰é’®)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ é™¤æˆåŠŸæç¤º:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ å·²åˆ é™¤                       â”‚
â”‚                                 â”‚
â”‚  [æ’¤é”€ (5s)]                    â”‚  â† 5ç§’å†…å¯æ’¤é”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº¤äº’ï¼š
- æ˜¾ç¤º5ç§’å€’è®¡æ—¶
- ç‚¹å‡»"æ’¤é”€"ç«‹å³æ¢å¤
- 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
```

---

#### **3.7.4 æŠ€æœ¯å®ç°**

**APIå®ç°:**

```python
@router.put("/api/v1/nodes/{node_id}")
async def update_node(
    node_id: str,
    title: str = Body(..., min_length=1, max_length=100),
    content: str = Body(..., min_length=10, max_length=5000),
    tags: List[str] = Body(default=[]),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    ç¼–è¾‘èŠ‚ç‚¹
    """
    # 1. éªŒè¯å½’å±
    node = await db.get_node(node_id)
    if node.user_id != current_user.id:
        raise HTTPException(status_code=403, detail="Unauthorized")
    
    # 2. éªŒè¯æ ‡ç­¾
    if len(tags) > 5:
        raise HTTPException(status_code=400, detail="æœ€å¤š5ä¸ªæ ‡ç­¾")
    
    for tag in tags:
        if len(tag) > 10:
            raise HTTPException(status_code=400, detail="æ ‡ç­¾ä¸è¶…è¿‡10å­—ç¬¦")
    
    # 3. ä¿å­˜ç¼–è¾‘å†å²ï¼ˆå¯é€‰ï¼‰
    if ENABLE_EDIT_HISTORY:
        edit_history = NodeEditHistory(
            node_id=node_id,
            previous_title=node.title,
            previous_content=node.content,
            previous_tags=node.tags,
            edited_at=datetime.now()
        )
        await db.save(edit_history)
    
    # 4. æ›´æ–°èŠ‚ç‚¹
    node.title = title
    node.content = content
    node.tags = tags
    node.updated_at = datetime.now()
    node.is_user_edited = True  # æ ‡è®°ä¸ºç”¨æˆ·ç¼–è¾‘è¿‡
    
    await db.update(node)
    
    # 5. åŸ‹ç‚¹
    analytics.track(
        user_id=current_user.id,
        event='node_edited',
        properties={
            'node_id': node_id,
            'title_changed': title != node.title,
            'content_changed': content != node.content,
            'tags_changed': tags != node.tags
        }
    )
    
    return {
        'status': 'success',
        'node': node.to_dict()
    }


@router.delete("/api/v1/nodes/{node_id}")
async def delete_node(
    node_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    åˆ é™¤èŠ‚ç‚¹ï¼ˆè½¯åˆ é™¤ï¼‰
    """
    # 1. éªŒè¯å½’å±
    node = await db.get_node(node_id)
    if node.user_id != current_user.id:
        raise HTTPException(status_code=403, detail="Unauthorized")
    
    # 2. è½¯åˆ é™¤
    node.deleted_at = datetime.now()
    node.is_deleted = True
    await db.update(node)
    
    # 3. åŒæ—¶åˆ é™¤å…³è”çš„"æ€æƒ³å…±é¸£"
    await db.delete_resonances(node_id)
    
    # 4. åŸ‹ç‚¹
    analytics.track(
        user_id=current_user.id,
        event='node_deleted',
        properties={
            'node_id': node_id,
            'node_age_days': (datetime.now() - node.created_at).days,
            'repetition_count': node.memory_stats['repetition_count']
        }
    )
    
    return {
        'status': 'success',
        'message': 'èŠ‚ç‚¹å·²åˆ é™¤ï¼Œ30å¤©å†…å¯æ¢å¤'
    }


@router.post("/api/v1/nodes/{node_id}/restore")
async def restore_node(
    node_id: str,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    æ¢å¤å·²åˆ é™¤çš„èŠ‚ç‚¹
    """
    node = await db.get_node(node_id, include_deleted=True)
    
    if not node or node.user_id != current_user.id:
        raise HTTPException(status_code=404, detail="èŠ‚ç‚¹ä¸å­˜åœ¨")
    
    if not node.is_deleted:
        raise HTTPException(status_code=400, detail="èŠ‚ç‚¹æœªè¢«åˆ é™¤")
    
    # æ£€æŸ¥åˆ é™¤æ—¶é—´
    if (datetime.now() - node.deleted_at).days > 30:
        raise HTTPException(status_code=400, detail="æ¢å¤æœŸé™å·²è¿‡")
    
    # æ¢å¤
    node.is_deleted = False
    node.deleted_at = None
    await db.update(node)
    
    analytics.track(
        user_id=current_user.id,
        event='node_restored',
        properties={'node_id': node_id}
    )
    
    return {'status': 'success'}
```

---

#### **3.7.5 æ•°æ®åŸ‹ç‚¹**

| äº‹ä»¶åç§°                | è§¦å‘æ—¶æœº       | å…³é”®å‚æ•°                                      |
| ----------------------- | -------------- | --------------------------------------------- |
| `node_edit_click`       | ç‚¹å‡»"ç¼–è¾‘"     | `node_id`                                     |
| `node_edited`           | ä¿å­˜ç¼–è¾‘       | `node_id`, `title_changed`, `content_changed` |
| `node_delete_click`     | ç‚¹å‡»"åˆ é™¤"     | `node_id`                                     |
| `node_delete_confirmed` | ç¡®è®¤åˆ é™¤       | `node_id`, `node_age_days`                    |
| `node_delete_undo`      | æ’¤é”€åˆ é™¤       | `node_id`                                     |
| `node_restored`         | æ¢å¤å·²åˆ é™¤èŠ‚ç‚¹ | `node_id`                                     |

---

#### **3.7.6 éªŒæ”¶æ ‡å‡†**

- [ ] ç¼–è¾‘åŠŸèƒ½æ­£å¸¸ï¼Œå®æ—¶ä¿å­˜è‰ç¨¿
- [ ] åˆ é™¤éœ€äºŒæ¬¡ç¡®è®¤
- [ ] åˆ é™¤å5ç§’å†…å¯æ’¤é”€
- [ ] è½¯åˆ é™¤çš„èŠ‚ç‚¹ä¸åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
- [ ] 30å¤©å†…å¯æ¢å¤åˆ é™¤çš„èŠ‚ç‚¹
- [ ] ç¼–è¾‘å"æ€æƒ³å…±é¸£"é‡æ–°è®¡ç®—ï¼ˆå¼‚æ­¥ï¼‰

---

### **3.8 US8: æ•°æ®å¯¼å‡º - ä½ çš„æ•°æ®ï¼Œä½ åšä¸»**

#### **3.8.1 åŠŸèƒ½ç›®æ ‡**

- ä¿éšœç”¨æˆ·æ•°æ®ä¸»æƒï¼Œå¢å¼ºä¿¡ä»»
- æ»¡è¶³éšç§åˆè§„è¦æ±‚ï¼ˆGDPRç­‰ï¼‰
- æä¾›æ•°æ®è¿ç§»èƒ½åŠ›

---

#### **3.8.2 å¯¼å‡ºæ ¼å¼**

| æ ¼å¼         | å†…å®¹         | ç”¨é€”           | V1.0æ”¯æŒ |
| ------------ | ------------ | -------------- | -------- |
| **JSON**     | å®Œæ•´æ•°æ®ç»“æ„ | æ•°æ®å¤‡ä»½ã€è¿ç§» | âœ…        |
| **Markdown** | äººç±»å¯è¯»æ ¼å¼ | ç¬”è®°è½¯ä»¶å¯¼å…¥   | âœ…        |
| **CSV**      | èŠ‚ç‚¹åˆ—è¡¨     | Excelåˆ†æ      | V1.1     |
| **PDF**      | æ‰“å°å‹å¥½     | å½’æ¡£           | V1.1     |

---

#### **3.8.3 ç•Œé¢ä¸äº¤äº’**

**è®¾ç½®é¡µ - æ•°æ®å¯¼å‡ºå…¥å£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è®¾ç½®]                       â”‚
â”‚                                 â”‚
â”‚  æ•°æ®ä¸éšç§                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  ğŸ“¤ å¯¼å‡ºæˆ‘çš„æ•°æ®                â”‚
â”‚  ğŸ—‘ï¸ åˆ é™¤æˆ‘çš„è´¦æˆ·ï¼ˆV1.1ï¼‰        â”‚
â”‚  ğŸ“„ éšç§æ”¿ç­–                    â”‚
â”‚  ğŸ“‹ ç”¨æˆ·åè®®                    â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¼å‡ºé€‰é¡¹é¡µ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [< è¿”å›]       å¯¼å‡ºæ•°æ®         â”‚
â”‚                                 â”‚
â”‚  é€‰æ‹©å¯¼å‡ºæ ¼å¼                   â”‚
â”‚                                 â”‚
â”‚  â—‹ JSONï¼ˆå®Œæ•´æ•°æ®ï¼‰             â”‚
â”‚     åŒ…å«æ‰€æœ‰èŠ‚ç‚¹ã€å…³è”ã€è®°å¿†å‚æ•°  â”‚
â”‚                                 â”‚
â”‚  â— Markdownï¼ˆç¬”è®°æ ¼å¼ï¼‰          â”‚
â”‚     é€‚åˆå¯¼å…¥Notionã€Obsidian    â”‚
â”‚                                 â”‚
â”‚  å¯¼å‡ºå†…å®¹                       â”‚
â”‚  â˜‘ï¸ æ™ºæ…§èŠ‚ç‚¹ (156ä¸ª)            â”‚
â”‚  â˜‘ï¸ æ€æƒ³å…±é¸£ (89ä¸ª)             â”‚
â”‚  â˜‘ï¸ å¤ä¹ å†å²                    â”‚
â”‚  â˜ åŸå§‹éŸ³é¢‘/å›¾ç‰‡                â”‚
â”‚                                 â”‚
â”‚  [å¼€å§‹å¯¼å‡º]                     â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¼å‡ºè¿›åº¦:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚  æ­£åœ¨å¯¼å‡ºä½ çš„æ•°æ®...             â”‚
â”‚                                 â”‚
â”‚  [è¿›åº¦æ¡] 60%                   â”‚
â”‚                                 â”‚
â”‚  å·²å¯¼å‡º 94/156 ä¸ªèŠ‚ç‚¹            â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¼å‡ºå®Œæˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ å¯¼å‡ºå®Œæˆï¼                   â”‚
â”‚                                 â”‚
â”‚  æ–‡ä»¶åï¼š                       â”‚
â”‚  weave_export_20251021.zip      â”‚
â”‚                                 â”‚
â”‚  å¤§å°ï¼š2.3 MB                   â”‚
â”‚                                 â”‚
â”‚  [ğŸ“¥ ä¸‹è½½åˆ°æ‰‹æœº]                â”‚
â”‚  [ğŸ“§ å‘é€åˆ°é‚®ç®±]                â”‚
â”‚                                 â”‚
â”‚  ğŸ’¡ æ–‡ä»¶å°†ä¿ç•™7å¤©                â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **3.8.4 æŠ€æœ¯å®ç°**

```python
@router.post("/api/v1/export/request")
async def request_data_export(
    format: str = Body(...),  # 'json' or 'markdown'
    include_media: bool = Body(default=False),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """
    è¯·æ±‚æ•°æ®å¯¼å‡ºï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    """
    # 1. åˆ›å»ºå¯¼å‡ºä»»åŠ¡
    export_task = ExportTask(
        user_id=current_user.id,
        format=format,
        include_media=include_media,
        status='pending',
        created_at=datetime.now()
    )
    await db.save(export_task)
    
    # 2. è§¦å‘å¼‚æ­¥ä»»åŠ¡
    asyncio.create_task(
        execute_export(export_task.id)
    )
    
    return {
        'status': 'success',
        'task_id': export_task.id,
        'message': 'å¯¼å‡ºä»»åŠ¡å·²åˆ›å»ºï¼Œé¢„è®¡éœ€è¦1-3åˆ†é’Ÿ'
    }


async def execute_export(task_id: str):
    """
    æ‰§è¡Œå¯¼å‡ºä»»åŠ¡
    """
    task = await db.get_export_task(task_id)
    user_id = task.user_id
    
    try:
        # 1. è·å–æ‰€æœ‰æ•°æ®
        nodes = await db.get_user_nodes(user_id, include_deleted=False)
        resonances = await db.get_user_resonances(user_id)
        reviews = await db.get_user_review_logs(user_id)
        
        # 2. æ ¹æ®æ ¼å¼ç”Ÿæˆæ–‡ä»¶
        if task.format == 'json':
            content = generate_json_export(nodes, resonances, reviews)
            filename = f'weave_export_{datetime.now().strftime("%Y%m%d")}.json'
        
        elif task.format == 'markdown':
            content = generate_markdown_export(nodes, resonances)
            filename = f'weave_export_{datetime.now().strftime("%Y%m%d")}.md'
        
        # 3. ä¸Šä¼ åˆ°äº‘å­˜å‚¨
        download_url = await upload_to_cloud(content, filename)
        
        # 4. æ›´æ–°ä»»åŠ¡çŠ¶æ€
        task.status = 'completed'
        task.download_url = download_url
        task.file_size = len(content)
        task.completed_at = datetime.now()
        await db.update(task)
        
        # 5. é€šçŸ¥ç”¨æˆ·
        await notify_export_ready(user_id, download_url)
        
    except Exception as e:
        task.status = 'failed'
        task.error_message = str(e)
        await db.update(task)


def generate_markdown_export(nodes, resonances):
    """
    ç”ŸæˆMarkdownæ ¼å¼å¯¼å‡º
    """
    md = "# æˆ‘çš„Weaveæ€æƒ³åº“\n\n"
    md += f"å¯¼å‡ºæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
    md += f"å…±{len(nodes)}ä¸ªæ™ºæ…§èŠ‚ç‚¹\n\n"
    md += "---\n\n"
    
    for node in nodes:
        md += f"## {node.title}\n\n"
        md += f"{node.content}\n\n"
        md += f"**æ ‡ç­¾ï¼š** {' '.join(['#' + tag for tag in node.tags])}\n\n"
        md += f"**åˆ›å»ºæ—¶é—´ï¼š** {node.created_at.strftime('%Y-%m-%d')}\n\n"
        
        # æ·»åŠ å…³è”
        node_resonances = [r for r in resonances if r.source_node_id == node.id]
        if node_resonances:
            md += "**æ€æƒ³å…±é¸£ï¼š**\n\n"
            for res in node_resonances:
                related = next(n for n in nodes if n.id == res.related_node_id)
                md += f"- [[{related.title}]]\n"
            md += "\n"
        
        md += "---\n\n"
    
    return md
```

